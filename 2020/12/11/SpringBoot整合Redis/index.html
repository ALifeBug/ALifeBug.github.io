<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>SpringBoot整合Redis | ALifeBug</title><meta name="description" content="SpringBoot整合Redis"><meta name="keywords" content="SpringBoot,Redis"><meta name="author" content="Huang Qingshan"><meta name="copyright" content="Huang Qingshan"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://alifebug.github.io/2020/12/11/SpringBoot%E6%95%B4%E5%90%88Redis/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SpringBoot整合Redis"><meta name="twitter:description" content="SpringBoot整合Redis"><meta name="twitter:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta property="og:type" content="article"><meta property="og:title" content="SpringBoot整合Redis"><meta property="og:url" content="http://alifebug.github.io/2020/12/11/SpringBoot%E6%95%B4%E5%90%88Redis/"><meta property="og:site_name" content="ALifeBug"><meta property="og:description" content="SpringBoot整合Redis"><meta property="og:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="归并排序" href="http://alifebug.github.io/2020/12/11/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F/"><link rel="next" title="SpringBoot事务使用" href="http://alifebug.github.io/2020/12/11/SpringBoot%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">ALifeBug</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">61</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">24</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#SpringBoot整合Redis"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">SpringBoot整合Redis</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#一、NoSQL-概述"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">一、NoSQL 概述</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#什么是-NoSQL-？"><span class="toc_mobile_items-number">1.1.0.1.</span> <span class="toc_mobile_items-text">什么是 NoSQL ？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#为什么需要-NoSQL-？"><span class="toc_mobile_items-number">1.1.0.2.</span> <span class="toc_mobile_items-text">为什么需要 NoSQL ？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#NoSQL-数据库的四大分类"><span class="toc_mobile_items-number">1.1.0.3.</span> <span class="toc_mobile_items-text">NoSQL 数据库的四大分类</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#NoSQL-的特点"><span class="toc_mobile_items-number">1.1.0.4.</span> <span class="toc_mobile_items-text">NoSQL 的特点</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#二、Redis-概述"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">二、Redis 概述</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Redis的应用场景"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">Redis的应用场景</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Redis-安装"><span class="toc_mobile_items-number">1.2.2.</span> <span class="toc_mobile_items-text">Redis 安装</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#三、注解方式使用-Redis-缓存"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">三、注解方式使用 Redis 缓存</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-1-添加缓存"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">3.1 添加缓存</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-2-更新缓存"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">3.2 更新缓存</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-3-删除缓存"><span class="toc_mobile_items-number">1.3.3.</span> <span class="toc_mobile_items-text">3.3 删除缓存</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-4-其他常用功能"><span class="toc_mobile_items-number">1.3.4.</span> <span class="toc_mobile_items-text">3.4 其他常用功能</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#四、RedisTemplate-使用-Redis-缓存"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">四、RedisTemplate 使用 Redis 缓存</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4-1-Redis-配置"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">4.1 Redis 配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4-2-Redis-的数据结构类型"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">4.2 Redis 的数据结构类型</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4-3-StringRedisTemplate-与-RedisTemplate"><span class="toc_mobile_items-number">1.4.3.</span> <span class="toc_mobile_items-text">4.3 StringRedisTemplate 与 RedisTemplate</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#StringRedisTemplate-与-RedisTemplate-的区别"><span class="toc_mobile_items-number">1.4.3.1.</span> <span class="toc_mobile_items-text">StringRedisTemplate 与 RedisTemplate 的区别</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#4-4-项目中使用"><span class="toc_mobile_items-number">1.4.4.</span> <span class="toc_mobile_items-text">4.4 项目中使用</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#用-RedisTemplate-操作-Hash"><span class="toc_mobile_items-number">1.4.4.1.</span> <span class="toc_mobile_items-text">用 RedisTemplate 操作 Hash</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#五、Redis-实现分布式锁"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">五、Redis 实现分布式锁</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringBoot整合Redis"><span class="toc-number">1.</span> <span class="toc-text">SpringBoot整合Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、NoSQL-概述"><span class="toc-number">1.1.</span> <span class="toc-text">一、NoSQL 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#什么是-NoSQL-？"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">什么是 NoSQL ？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#为什么需要-NoSQL-？"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">为什么需要 NoSQL ？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NoSQL-数据库的四大分类"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">NoSQL 数据库的四大分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NoSQL-的特点"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">NoSQL 的特点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Redis-概述"><span class="toc-number">1.2.</span> <span class="toc-text">二、Redis 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis的应用场景"><span class="toc-number">1.2.1.</span> <span class="toc-text">Redis的应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-安装"><span class="toc-number">1.2.2.</span> <span class="toc-text">Redis 安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、注解方式使用-Redis-缓存"><span class="toc-number">1.3.</span> <span class="toc-text">三、注解方式使用 Redis 缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-添加缓存"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 添加缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-更新缓存"><span class="toc-number">1.3.2.</span> <span class="toc-text">3.2 更新缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-删除缓存"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.3 删除缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-其他常用功能"><span class="toc-number">1.3.4.</span> <span class="toc-text">3.4 其他常用功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、RedisTemplate-使用-Redis-缓存"><span class="toc-number">1.4.</span> <span class="toc-text">四、RedisTemplate 使用 Redis 缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Redis-配置"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 Redis 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Redis-的数据结构类型"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 Redis 的数据结构类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-StringRedisTemplate-与-RedisTemplate"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 StringRedisTemplate 与 RedisTemplate</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#StringRedisTemplate-与-RedisTemplate-的区别"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">StringRedisTemplate 与 RedisTemplate 的区别</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-项目中使用"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4 项目中使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用-RedisTemplate-操作-Hash"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">用 RedisTemplate 操作 Hash</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、Redis-实现分布式锁"><span class="toc-number">1.5.</span> <span class="toc-text">五、Redis 实现分布式锁</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">SpringBoot整合Redis</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-12-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-12-11</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Redis/">Redis</a></span><div class="post-meta-wordcount"><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="SpringBoot整合Redis"><a href="#SpringBoot整合Redis" class="headerlink" title="SpringBoot整合Redis"></a>SpringBoot整合Redis</h1><p>本文主要讲 Redis 的使用，如何与 SpringBoot 项目整合，如何使用注解方式和 RedisTemplate 方式实现缓存。最后会给一个用 Redis 实现分布式锁，用在秒杀系统中的案例。</p>
<h2 id="一、NoSQL-概述"><a href="#一、NoSQL-概述" class="headerlink" title="一、NoSQL 概述"></a>一、NoSQL 概述</h2><h4 id="什么是-NoSQL-？"><a href="#什么是-NoSQL-？" class="headerlink" title="什么是 NoSQL ？"></a>什么是 NoSQL ？</h4><p>NoSQL(NoSQL = Not Only SQL )，意即“不仅仅是<a href="https://baike.baidu.com/item/SQL" target="_blank" rel="noopener">SQL</a>”，泛指非关系型的数据库。</p>
<h4 id="为什么需要-NoSQL-？"><a href="#为什么需要-NoSQL-？" class="headerlink" title="为什么需要 NoSQL ？"></a>为什么需要 NoSQL ？</h4><p>随着互联网<a href="https://baike.baidu.com/item/web2.0/97695" target="_blank" rel="noopener">web2.0</a>网站的兴起，传统的关系数据库在应付web2.0网站，特别是超大规模和高并发的<a href="https://baike.baidu.com/item/SNS/10242" target="_blank" rel="noopener">SNS</a>类型的web2.0纯<a href="https://baike.baidu.com/item/%E5%8A%A8%E6%80%81%E7%BD%91" target="_blank" rel="noopener">动态网</a>站已经显得力不从心，暴露了很多难以克服的问题，而非关系型的数据库则由于其本身的特点得到了非常迅速的发展。NoSQL数据库的产生就是为了解决大规模数据集合多重数据种类带来的挑战，尤其是大数据应用难题。 – 百度百科</p>
<h4 id="NoSQL-数据库的四大分类"><a href="#NoSQL-数据库的四大分类" class="headerlink" title="NoSQL 数据库的四大分类"></a>NoSQL 数据库的四大分类</h4><ul>
<li>键值（key-value）存储</li>
<li>列存储</li>
<li>文档数据库</li>
<li>图形数据库</li>
</ul>
<table>
<thead>
<tr>
<th>分类</th>
<th>相关产品</th>
<th>典型应用</th>
<th>数据模型</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>键值（key-value)</td>
<td>Tokyo、 Cabinet/Tyrant、Redis、Voldemort、Berkeley DB</td>
<td>内容缓存，主要用于处理大量数据的高访问负载</td>
<td>一系列键值对</td>
<td>快速查询</td>
<td>存储的数据缺少结构化</td>
</tr>
<tr>
<td>列存储数据库</td>
<td>Cassandra, HBase, Riak</td>
<td>分布式的文件系统</td>
<td>以列簇式存储，将同一列数据存在一起</td>
<td>查找速度快，可扩展性强，更容易进行分布式扩展</td>
<td>功能相对局限</td>
</tr>
<tr>
<td>文档数据库</td>
<td>CouchDB, MongoDB</td>
<td>Web应用（与Key-Value类似，value是结构化的）</td>
<td>一系列键值对</td>
<td>数据结构要求不严格</td>
<td>查询性能不高，而且缺乏统一的查询语法</td>
</tr>
<tr>
<td>图形（Graph）数据库</td>
<td>Neo4J, InfoGrid, Infinite Graph</td>
<td>社交网络，推荐系统等。专注于构建关系图谱</td>
<td>图结构</td>
<td>利用图结构相关算法</td>
<td>需要对整个图做计算才能得出结果，不容易做分布式集群方案</td>
</tr>
</tbody></table>
<h4 id="NoSQL-的特点"><a href="#NoSQL-的特点" class="headerlink" title="NoSQL 的特点"></a>NoSQL 的特点</h4><ul>
<li>易扩展</li>
<li>灵活的数据模型</li>
<li>大数据量，高性能</li>
<li>高可用</li>
</ul>
<h2 id="二、Redis-概述"><a href="#二、Redis-概述" class="headerlink" title="二、Redis 概述"></a>二、Redis 概述</h2><h3 id="Redis的应用场景"><a href="#Redis的应用场景" class="headerlink" title="Redis的应用场景"></a>Redis的应用场景</h3><ul>
<li>缓存</li>
<li>任务队列</li>
<li>网站访问统计</li>
<li>应用排行榜</li>
<li>数据过期处理</li>
<li>分布式集群架构中的 session 分离</li>
</ul>
<h3 id="Redis-安装"><a href="#Redis-安装" class="headerlink" title="Redis 安装"></a>Redis 安装</h3><p>网上有很多 Redis 的安装教程，这里就不多说了，只说下 Docker 的安装方法：</p>
<p>Docker 安装运行 Redis</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 6379:6379 redis:4.0.8</span><br></pre></td></tr></tbody></table></figure>

<p>如果以后想启动 Redis 服务，打开命令行，输入以下命令即可。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server</span><br></pre></td></tr></tbody></table></figure>

<p>使用前先引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag"><<span class="name">dependency</span>></span></span><br><span class="line">    <span class="tag"><<span class="name">groupId</span>></span>org.springframework.boot<span class="tag"></<span class="name">groupId</span>></span></span><br><span class="line">    <span class="tag"><<span class="name">artifactId</span>></span>spring-boot-starter-data-redis<span class="tag"></<span class="name">artifactId</span>></span></span><br><span class="line"><span class="tag"></<span class="name">dependency</span>></span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="三、注解方式使用-Redis-缓存"><a href="#三、注解方式使用-Redis-缓存" class="headerlink" title="三、注解方式使用 Redis 缓存"></a>三、注解方式使用 Redis 缓存</h2><p>使用缓存有两个前置步骤</p>
<ol>
<li><p>在 <code>pom.xml</code> 引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag"><<span class="name">dependency</span>></span></span><br><span class="line">    <span class="tag"><<span class="name">groupId</span>></span>org.springframework.boot<span class="tag"></<span class="name">groupId</span>></span></span><br><span class="line">    <span class="tag"><<span class="name">artifactId</span>></span>spring-boot-starter-data-redis<span class="tag"></<span class="name">artifactId</span>></span></span><br><span class="line"><span class="tag"></<span class="name">dependency</span>></span></span><br><span class="line">1234</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在启动类上加注解 <code>@EnableCaching</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SellApplication</span> </span>{</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">		SpringApplication.run(SellApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<p>常用的注解有以下几个</p>
<ul>
<li><p><code>@Cacheable</code></p>
<p>属性如下图</p>
</li>
</ul>
<p><img alt="img" data-src="https://user-gold-cdn.xitu.io/2018/11/16/1671ba3f799fbc1c" class="lozad"></p>
<p>用于查询和添加缓存，第一次查询的时候返回该方法返回值，并向 Redis 服务器保存数据。</p>
<p>以后调用该方法先从 Redis 中查是否有数据，如果有直接返回 Redis 缓存的数据，而不执行方法里的代码。如果没有则正常执行方法体中的代码。</p>
<p>value 或 cacheNames 属性做键，key 属性则可以看作为 value 的子键， 一个 value 可以有多个 key 组成不同值存在 Redis 服务器。</p>
<p>验证了下，value 和 cacheNames 的作用是一样的，都是标识主键。两个属性不能同时定义，只能定义一个，否则会报错。</p>
<p>condition 和 unless 是条件，后面会讲用法。其他的几个属性不常用，其实我也不知道怎么用…</p>
<ul>
<li><p><code>@CachePut</code></p>
<p>更新 Redis 中对应键的值。属性和 <code>@Cacheable</code> 相同</p>
</li>
<li><p><code>@CacheEvict</code></p>
<p>删除 Redis 中对应键的值。</p>
</li>
</ul>
<h3 id="3-1-添加缓存"><a href="#3-1-添加缓存" class="headerlink" title="3.1 添加缓存"></a>3.1 添加缓存</h3><p>在需要加缓存的方法上添加注解 <code>@Cacheable(cacheNames = "product", key = "123")</code>,</p>
<p><code>cacheNames</code> 和 <code>key</code> 都必须填，如果不填 <code>key</code> ，默认的 <code>key</code> 是当前的方法名，更新缓存时会因为方法名不同而更新失败。</p>
<p>如在订单列表上加缓存</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/list"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@Cacheable</span>(cacheNames = <span class="string">"product"</span>, key = <span class="string">"123"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultVO <span class="title">list</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.查询所有上架商品</span></span><br><span class="line">    List<ProductInfo> productInfoList = productInfoService.findUpAll();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.查询类目（一次性查询）</span></span><br><span class="line">    <span class="comment">//用 java8 的特性获取到上架商品的所有类型</span></span><br><span class="line">    List<Integer> categoryTypes = productInfoList.stream().map(e -> e.getCategoryType()).collect(Collectors.toList());</span><br><span class="line">    List<ProductCategory> productCategoryList = categoryService.findByCategoryTypeIn(categoryTypes);</span><br><span class="line"></span><br><span class="line">    List<ProductVO> productVOList = <span class="keyword">new</span> ArrayList<>();</span><br><span class="line">    <span class="comment">//数据拼装</span></span><br><span class="line">    <span class="keyword">for</span> (ProductCategory category : productCategoryList) {</span><br><span class="line">        ProductVO productVO = <span class="keyword">new</span> ProductVO();</span><br><span class="line">        <span class="comment">//属性拷贝</span></span><br><span class="line">        BeanUtils.copyProperties(category, productVO);</span><br><span class="line">        <span class="comment">//把类型匹配的商品添加进去</span></span><br><span class="line">        List<ProductInfoVO> productInfoVOList = <span class="keyword">new</span> ArrayList<>();</span><br><span class="line">        <span class="keyword">for</span> (ProductInfo productInfo : productInfoList) {</span><br><span class="line">            <span class="keyword">if</span> (productInfo.getCategoryType().equals(category.getCategoryType())) {</span><br><span class="line">                ProductInfoVO productInfoVO = <span class="keyword">new</span> ProductInfoVO();</span><br><span class="line">                BeanUtils.copyProperties(productInfo, productInfoVO);</span><br><span class="line">                productInfoVOList.add(productInfoVO);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        productVO.setProductInfoVOList(productInfoVOList);</span><br><span class="line">        productVOList.add(productVO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ResultVOUtils.success(productVOList);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可能会报如下错误</p>
<p><img alt="img" data-src="https://user-gold-cdn.xitu.io/2018/11/16/1671ba4bf859b80c?w=2760&h=438&f=png&s=126526" class="lozad"></p>
<p>对象未序列化。让对象实现 <code>Serializable</code> 方法即可</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductVO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">961235512220891746L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"name"</span>)</span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"type"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer categoryType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty</span>(<span class="string">"foods"</span>)</span><br><span class="line">    <span class="keyword">private</span> List<ProductInfoVO> productInfoVOList ;</span><br><span class="line">}</span><br><span class="line"><span class="number">1234567891011121314</span></span><br></pre></td></tr></tbody></table></figure>

<p>生成唯一的 id 在 IDEA 里有一个插件：<code>GenerateSerialVersionUID</code> 比较方便。</p>
<p>重启项目访问订单列表，在 rdm 里查看 Redis 缓存，有 <code>product::123</code> 说明缓存成功。</p>
<p><img alt="img" data-src="https://user-gold-cdn.xitu.io/2018/11/16/1671ba576c72589f?w=1990&h=1330&f=png&s=416894" class="lozad"></p>
<h3 id="3-2-更新缓存"><a href="#3-2-更新缓存" class="headerlink" title="3.2 更新缓存"></a>3.2 更新缓存</h3><p>在需要更新缓存的方法上加注解： <code>@CachePut(cacheNames = "prodcut", key = "123")</code></p>
<p>注意</p>
<blockquote>
<ol>
<li><code>cacheNames</code> 和 <code>key</code> 要跟 <code>@Cacheable()</code> 里的一致，才会正确更新。</li>
<li><code>@CachePut()</code> 和 <code>@Cacheable()</code> 注解的方法返回值要一致</li>
</ol>
</blockquote>
<h3 id="3-3-删除缓存"><a href="#3-3-删除缓存" class="headerlink" title="3.3 删除缓存"></a>3.3 删除缓存</h3><p>在需要删除缓存的方法上加注解：<code>@CacheEvict(cacheNames = "prodcut", key = "123")</code>，执行完这个方法之后会将 Redis 中对应的记录删除。</p>
<h3 id="3-4-其他常用功能"><a href="#3-4-其他常用功能" class="headerlink" title="3.4 其他常用功能"></a>3.4 其他常用功能</h3><ol>
<li><p><code>cacheNames</code> 也可以统一写在类上面， <code>@CacheConfig(cacheNames = "product")</code> ，具体的方法上就不用写啦。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheConfig</span>(cacheNames = <span class="string">"product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyerOrderController</span> </span>{</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/cancel"</span>)</span><br><span class="line">	<span class="meta">@CachePut</span>(key = <span class="string">"456"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultVO <span class="title">cancel</span><span class="params">(@RequestParam(<span class="string">"openid"</span>)</span> String openid,</span></span><br><span class="line"><span class="function">                           @<span class="title">RequestParam</span><span class="params">(<span class="string">"orderId"</span>)</span> String orderId)</span>{</span><br><span class="line">        buyerService.cancelOrder(openid, orderId);</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtils.success();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="number">12345678910</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Key 也可以动态设置为方法的参数</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/detail"</span>)</span><br><span class="line"><span class="meta">@Cacheable</span>(cacheNames = <span class="string">"prodcut"</span>, key = <span class="string">"#openid"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultVO<OrderDTO> <span class="title">detail</span><span class="params">(@RequestParam(<span class="string">"openid"</span>)</span> String openid,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(<span class="string">"orderId"</span>)</span> String orderId)</span>{</span><br><span class="line">    OrderDTO orderDTO = buyerService.findOrderOne(openid, orderId);</span><br><span class="line">    <span class="keyword">return</span> ResultVOUtils.success(orderDTO);</span><br><span class="line">}</span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果参数是个对象，也可以设置对象的某个属性为 key。比如其中一个参数是 user 对象，key 可以写成 <code>key="#user.id"</code></p>
</li>
<li><p>缓存还可以设置条件。</p>
<p>设置当 openid 的长度大于3时才缓存</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/detail"</span>)</span><br><span class="line"><span class="meta">@Cacheable</span>(cacheNames = <span class="string">"prodcut"</span>, key = <span class="string">"#openid"</span>, condition = <span class="string">"#openid.length > 3"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultVO<OrderDTO> <span class="title">detail</span><span class="params">(@RequestParam(<span class="string">"openid"</span>)</span> String openid,</span></span><br><span class="line"><span class="function">                                 @<span class="title">RequestParam</span><span class="params">(<span class="string">"orderId"</span>)</span> String orderId)</span>{</span><br><span class="line">    OrderDTO orderDTO = buyerService.findOrderOne(openid, orderId);</span><br><span class="line">    <span class="keyword">return</span> ResultVOUtils.success(orderDTO);</span><br><span class="line">}</span><br><span class="line"><span class="number">1234567</span></span><br></pre></td></tr></tbody></table></figure>

<p>还可以指定 <code>unless</code> 即条件不成立时缓存。<code>#result</code> 代表返回值，意思是当返回码不等于 0 时不缓存，也就是等于 0 时才缓存。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/detail"</span>)</span><br><span class="line"><span class="meta">@Cacheable</span>(cacheNames = <span class="string">"prodcut"</span>, key = <span class="string">"#openid"</span>, condition = <span class="string">"#openid.length > 3"</span>, unless = <span class="string">"#result.code != 0"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultVO<OrderDTO> <span class="title">detail</span><span class="params">(@RequestParam(<span class="string">"openid"</span>)</span> String openid,</span></span><br><span class="line"><span class="function">                                 @<span class="title">RequestParam</span><span class="params">(<span class="string">"orderId"</span>)</span> String orderId)</span>{</span><br><span class="line">    OrderDTO orderDTO = buyerService.findOrderOne(openid, orderId);</span><br><span class="line">    <span class="keyword">return</span> ResultVOUtils.success(orderDTO);</span><br><span class="line">}</span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h2 id="四、RedisTemplate-使用-Redis-缓存"><a href="#四、RedisTemplate-使用-Redis-缓存" class="headerlink" title="四、RedisTemplate 使用 Redis 缓存"></a>四、RedisTemplate 使用 Redis 缓存</h2><p>与使用注解方式不同，注解方式可以零配置，只需引入依赖并在启动类上加上 <code>@EnableCaching</code> 注解就可以使用；而使用 RedisTemplate 方式麻烦些，需要做一些配置。</p>
<h3 id="4-1-Redis-配置"><a href="#4-1-Redis-配置" class="headerlink" title="4.1 Redis 配置"></a>4.1 Redis 配置</h3><p>第一步还是引入依赖和在启动类上加上 <code>@EnableCaching</code> 注解。</p>
<p>然后在 <code>application.yml</code> 文件中配置 Redis</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5000ms</span></span><br><span class="line"><span class="number">12345678910111213</span></span><br></pre></td></tr></tbody></table></figure>

<p>然后写个 <code>RedisConfig.java</code> 配置类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.solo.coderiver.user.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate<String, Object> <span class="title">redisTemplate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> UnknownHostException </span>{</span><br><span class="line"></span><br><span class="line">        Jackson2JsonRedisSerializer<Object> jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer<Object>(Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line"></span><br><span class="line">        RedisTemplate<String, Object> template = <span class="keyword">new</span> RedisTemplate<String, Object>();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        template.setKeySerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.setHashKeySerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(StringRedisTemplate<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">StringRedisTemplate</span> <span class="title">stringRedisTemplate</span>(</span></span><br><span class="line"><span class="class">            <span class="title">RedisConnectionFactory</span> <span class="title">redisConnectionFactory</span>)</span></span><br><span class="line"><span class="class">            <span class="title">throws</span> <span class="title">UnknownHostException</span> </span>{</span><br><span class="line">        StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Redis 的配置就完成了。</p>
<h3 id="4-2-Redis-的数据结构类型"><a href="#4-2-Redis-的数据结构类型" class="headerlink" title="4.2 Redis 的数据结构类型"></a>4.2 Redis 的数据结构类型</h3><p>Redis 可以存储键与5种不同数据结构类型之间的映射，这5种数据结构类型分别为String（字符串）、List（列表）、Set（集合）、Hash（散列）和 Zset（有序集合）。</p>
<p>下面来对这5种数据结构类型作简单的介绍：</p>
<table>
<thead>
<tr>
<th>结构类型</th>
<th>结构存储的值</th>
<th>结构的读写能力</th>
</tr>
</thead>
<tbody><tr>
<td>String</td>
<td>可以是字符串、整数或者浮点数</td>
<td>对整个字符串或者字符串的其中一部分执行操作；对象和浮点数执行自增(increment)或者自减(decrement)</td>
</tr>
<tr>
<td>List</td>
<td>一个链表，链表上的每个节点都包含了一个字符串</td>
<td>从链表的两端推入或者弹出元素；根据偏移量对链表进行修剪(trim)；读取单个或者多个元素；根据值来查找或者移除元素</td>
</tr>
<tr>
<td>Set</td>
<td>包含字符串的无序收集器(unorderedcollection)，并且被包含的每个字符串都是独一无二的、各不相同</td>
<td>添加、获取、移除单个元素；检查一个元素是否存在于某个集合中；计算交集、并集、差集；从集合里卖弄随机获取元素</td>
</tr>
<tr>
<td>Hash</td>
<td>包含键值对的无序散列表</td>
<td>添加、获取、移除单个键值对；获取所有键值对</td>
</tr>
<tr>
<td>Zset</td>
<td>字符串成员(member)与浮点数分值(score)之间的有序映射，元素的排列顺序由分值的大小决定</td>
<td>添加、获取、删除单个元素；根据分值范围(range)或者成员来获取元素</td>
</tr>
</tbody></table>
<h3 id="4-3-StringRedisTemplate-与-RedisTemplate"><a href="#4-3-StringRedisTemplate-与-RedisTemplate" class="headerlink" title="4.3 StringRedisTemplate 与 RedisTemplate"></a>4.3 StringRedisTemplate 与 RedisTemplate</h3><p>RedisTemplate 对五种数据结构分别定义了操作</p>
<ul>
<li><p>redisTemplate.opsForValue();</p>
<p>操作字符串</p>
</li>
<li><p>redisTemplate.opsForHash();</p>
<p>操作hash</p>
</li>
<li><p>redisTemplate.opsForList();</p>
<p>操作list</p>
</li>
<li><p>redisTemplate.opsForSet();</p>
<p>操作set</p>
</li>
<li><p>redisTemplate.opsForZSet();</p>
<p>操作有序set</p>
</li>
</ul>
<p>如果操作字符串的话，建议用 <code>StringRedisTemplate</code> 。</p>
<h4 id="StringRedisTemplate-与-RedisTemplate-的区别"><a href="#StringRedisTemplate-与-RedisTemplate-的区别" class="headerlink" title="StringRedisTemplate 与 RedisTemplate 的区别"></a>StringRedisTemplate 与 RedisTemplate 的区别</h4><ol>
<li>StringRedisTemplate 继承了 RedisTemplate。</li>
<li>RedisTemplate 是一个泛型类，而 StringRedisTemplate 则不是。</li>
<li>StringRedisTemplate 只能对 key=String，value=String 的键值对进行操作，RedisTemplate 可以对任何类型的 key-value 键值对操作。</li>
<li>他们各自序列化的方式不同，但最终都是得到了一个字节数组，殊途同归，StringRedisTemplate 使用的是 StringRedisSerializer 类；RedisTemplate 使用的是 JdkSerializationRedisSerializer 类。反序列化，则是一个得到 String，一个得到 Object</li>
<li>两者的数据是不共通的，StringRedisTemplate 只能管理 StringRedisTemplate 里面的数据，RedisTemplate 只能管理 RedisTemplate中 的数据。</li>
</ol>
<h3 id="4-4-项目中使用"><a href="#4-4-项目中使用" class="headerlink" title="4.4 项目中使用"></a>4.4 项目中使用</h3><p>在需要使用 Redis 的地方，用 <code>@Autowired</code> 注入进来</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RedisTemplate redisTemplate;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="number">12345</span></span><br></pre></td></tr></tbody></table></figure>

<p>由于项目中暂时仅用到了 StringRedisTemplate 与 RedisTemplate 的 Hash 结构，StringRedisTemplate 比较简单就不贴代码了，下面仅对操作 Hash 进行举例。</p>
<p>关于 RedisTemplate 的详细用法，有一篇文章已经讲的很细很好了，我觉得没必要再去写了。<a href="https://www.jianshu.com/p/7bf5dc61ca06/" target="_blank" rel="noopener">传送门</a></p>
<h4 id="用-RedisTemplate-操作-Hash"><a href="#用-RedisTemplate-操作-Hash" class="headerlink" title="用 RedisTemplate 操作 Hash"></a>用 RedisTemplate 操作 Hash</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.solo.coderiver.user.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.dataobject.UserLike;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.dto.LikedCountDTO;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.enums.LikedStatusEnum;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.service.LikedService;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.service.RedisService;</span><br><span class="line"><span class="keyword">import</span> com.solo.coderiver.user.utils.RedisKeyUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.Cursor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.ScanOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisServiceImpl</span> <span class="keyword">implements</span> <span class="title">RedisService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LikedService likedService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveLiked2Redis</span><span class="params">(String likedUserId, String likedPostId)</span> </span>{</span><br><span class="line">        String key = RedisKeyUtils.getLikedKey(likedUserId, likedPostId);</span><br><span class="line">        redisTemplate.opsForHash().put(RedisKeyUtils.MAP_KEY_USER_LIKED, key, LikedStatusEnum.LIKE.getCode());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlikeFromRedis</span><span class="params">(String likedUserId, String likedPostId)</span> </span>{</span><br><span class="line">        String key = RedisKeyUtils.getLikedKey(likedUserId, likedPostId);</span><br><span class="line">        redisTemplate.opsForHash().put(RedisKeyUtils.MAP_KEY_USER_LIKED, key, LikedStatusEnum.UNLIKE.getCode());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteLikedFromRedis</span><span class="params">(String likedUserId, String likedPostId)</span> </span>{</span><br><span class="line">        String key = RedisKeyUtils.getLikedKey(likedUserId, likedPostId);</span><br><span class="line">        redisTemplate.opsForHash().delete(RedisKeyUtils.MAP_KEY_USER_LIKED, key);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrementLikedCount</span><span class="params">(String likedUserId)</span> </span>{</span><br><span class="line">        redisTemplate.opsForHash().increment(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, likedUserId, <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrementLikedCount</span><span class="params">(String likedUserId)</span> </span>{</span><br><span class="line">        redisTemplate.opsForHash().increment(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, likedUserId, -<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List<UserLike> <span class="title">getLikedDataFromRedis</span><span class="params">()</span> </span>{</span><br><span class="line">        Cursor<Map.Entry<Object, Object>> cursor = redisTemplate.opsForHash().scan(RedisKeyUtils.MAP_KEY_USER_LIKED, ScanOptions.NONE);</span><br><span class="line">        List<UserLike> list = <span class="keyword">new</span> ArrayList<>();</span><br><span class="line">        <span class="keyword">while</span> (cursor.hasNext()) {</span><br><span class="line">            Map.Entry<Object, Object> entry = cursor.next();</span><br><span class="line">            String key = (String) entry.getKey();</span><br><span class="line">            <span class="comment">//分离出 likedUserId，likedPostId</span></span><br><span class="line">            String[] split = key.split(<span class="string">"::"</span>);</span><br><span class="line">            String likedUserId = split[<span class="number">0</span>];</span><br><span class="line">            String likedPostId = split[<span class="number">1</span>];</span><br><span class="line">            Integer value = (Integer) entry.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//组装成 UserLike 对象</span></span><br><span class="line">            UserLike userLike = <span class="keyword">new</span> UserLike(likedUserId, likedPostId, value);</span><br><span class="line">            list.add(userLike);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//存到 list 后从 Redis 中删除</span></span><br><span class="line">            redisTemplate.opsForHash().delete(RedisKeyUtils.MAP_KEY_USER_LIKED, key);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List<LikedCountDTO> <span class="title">getLikedCountFromRedis</span><span class="params">()</span> </span>{</span><br><span class="line">        Cursor<Map.Entry<Object, Object>> cursor = redisTemplate.opsForHash().scan(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, ScanOptions.NONE);</span><br><span class="line">        List<LikedCountDTO> list = <span class="keyword">new</span> ArrayList<>();</span><br><span class="line">        <span class="keyword">while</span> (cursor.hasNext()) {</span><br><span class="line">            Map.Entry<Object, Object> map = cursor.next();</span><br><span class="line">            <span class="comment">//将点赞数量存储在 LikedCountDT</span></span><br><span class="line">            String key = (String) map.getKey();</span><br><span class="line">            LikedCountDTO dto = <span class="keyword">new</span> LikedCountDTO(key, (Integer) map.getValue());</span><br><span class="line">            list.add(dto);</span><br><span class="line">            <span class="comment">//从Redis中删除这条记录</span></span><br><span class="line">            redisTemplate.opsForHash().delete(RedisKeyUtils.MAP_KEY_USER_LIKED_COUNT, key);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="五、Redis-实现分布式锁"><a href="#五、Redis-实现分布式锁" class="headerlink" title="五、Redis 实现分布式锁"></a>五、Redis 实现分布式锁</h2><p>讲完了基础操作，再说个实战运用，用Redis 实现分布式锁 。</p>
<p>实现分布式锁之前先看两个 Redis 命令：</p>
<ul>
<li><p>SETNX</p>
<p>将<code>key</code>设置值为<code>value</code>，如果<code>key</code>不存在，这种情况下等同<a href="http://www.redis.cn/commands/set.html" target="_blank" rel="noopener">SET</a>命令。 当<code>key</code>存在时，什么也不做。<code>SETNX</code>是”<strong>SET</strong> if <strong>N</strong>ot e<strong>X</strong>ists”的简写。</p>
<p><strong>返回值</strong></p>
<p><a href="http://www.redis.cn/topics/protocol.html#integer-reply" target="_blank" rel="noopener">Integer reply</a>, 特定值:</p>
<ul>
<li><code>1</code> 如果key被设置了</li>
<li><code>0</code> 如果key没有被设置</li>
</ul>
<p><strong>例子</strong></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis></span><span class="bash"> SETNX mykey <span class="string">"Hello"</span></span></span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">redis></span><span class="bash"> SETNX mykey <span class="string">"World"</span></span></span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta">redis></span><span class="bash"> GET mykey</span></span><br><span class="line">"Hello"</span><br><span class="line"><span class="meta">redis></span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>GETSET</p>
<p>自动将key对应到value并且返回原来key对应的value。如果key存在但是对应的value不是字符串，就返回错误。</p>
<p>设计模式</p>
<p><a href="http://www.redis.cn/commands/getset.html" target="_blank" rel="noopener">GETSET</a>可以和<a href="http://www.redis.cn/commands/incr.html" target="_blank" rel="noopener">INCR</a>一起使用实现支持重置的计数功能。举个例子：每当有事件发生的时候，一段程序都会调用<a href="http://www.redis.cn/commands/incr.html" target="_blank" rel="noopener">INCR</a>给key mycounter加1，但是有时我们需要获取计数器的值，并且自动将其重置为0。这可以通过GETSET mycounter “0”来实现：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INCR mycounter</span><br><span class="line">GETSET mycounter "0"</span><br><span class="line">GET mycounter</span><br><span class="line">123</span><br></pre></td></tr></tbody></table></figure>

<p><strong>返回值</strong></p>
<p><a href="http://www.redis.cn/topics/protocol.html#bulk-string-reply" target="_blank" rel="noopener">bulk-string-reply</a>: 返回之前的旧值，如果之前<code>Key</code>不存在将返回<code>nil</code>。</p>
<p><strong>例子</strong></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">redis></span><span class="bash"> INCR mycounter</span></span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">redis></span><span class="bash"> GETSET mycounter <span class="string">"0"</span></span></span><br><span class="line">"1"</span><br><span class="line"><span class="meta">redis></span><span class="bash"> GET mycounter</span></span><br><span class="line">"0"</span><br><span class="line"><span class="meta">redis></span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<p>这两个命令在 java 中对应为 <code>setIfAbsent</code> 和 <code>getAndSet</code></p>
<p>分布式锁的实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLock</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 当前时间 + 超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String key, String value)</span></span>{</span><br><span class="line">        <span class="keyword">if</span> (redisTemplate.opsForValue().setIfAbsent(key, value)){</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解决死锁，且当多个线程同时来时，只会让一个线程拿到锁</span></span><br><span class="line">        String currentValue = redisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//如果过期</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(currentValue) &&</span><br><span class="line">                Long.parseLong(currentValue) < System.currentTimeMillis()){</span><br><span class="line">            <span class="comment">//获取上一个锁的时间</span></span><br><span class="line">            String oldValue = redisTemplate.opsForValue().getAndSet(key, value);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(oldValue) && oldValue.equals(currentValue)){</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(String key, String value)</span></span>{</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            String currentValue = redisTemplate.opsForValue().get(key);</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(currentValue) && currentValue.equals(value)){</span><br><span class="line">                redisTemplate.opsForValue().getOperations().delete(key);</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">catch</span> (Exception e){</span><br><span class="line">            log.error(<span class="string">"【redis锁】解锁失败, {}"</span>, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟秒杀</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecKillService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisLock redisLock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//超时时间10s</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIMEOUT = <span class="number">10</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">secKill</span><span class="params">(String productId)</span></span>{</span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis() + TIMEOUT;</span><br><span class="line">        <span class="comment">//加锁</span></span><br><span class="line">        <span class="keyword">if</span> (!redisLock.lock(productId, String.valueOf(time))){</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SellException(<span class="number">101</span>, <span class="string">"人太多了，等会儿再试吧~"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//具体的秒杀逻辑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//解锁</span></span><br><span class="line">        redisLock.unlock(productId, String.valueOf(time));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>coderiver 中文名 河码，是一个为程序员和设计师提供项目协作的平台。无论你是前端、后端、移动端开发人员，或是设计师、产品经理，都可以在平台上发布项目，与志同道合的小伙伴一起协作完成项目。</p>
<p>coderiver河码 类似程序员客栈，但主要目的是方便各细分领域人才之间技术交流，共同成长，多人协作完成项目。暂不涉及金钱交易。</p>
<p>计划做成包含 pc端（Vue、React）、移动H5（Vue、React）、ReactNative混合开发、Android原生、微信小程序、java后端的全平台型全栈项目，欢迎关注。</p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Huang Qingshan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://alifebug.github.io/2020/12/11/SpringBoot%E6%95%B4%E5%90%88Redis/">http://alifebug.github.io/2020/12/11/SpringBoot%E6%95%B4%E5%90%88Redis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://ALifeBug.github.io">ALifeBug</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot    </a><a class="post-meta__tags" href="/tags/Redis/">Redis    </a></div><div class="post_share"><div class="social-share" data-image="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.png"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.png"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/11/%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F/"><img class="prev_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>归并排序</span></div></a></div><div class="next-post pull-right"><a href="/2020/12/11/SpringBoot%E4%BA%8B%E5%8A%A1%E4%BD%BF%E7%94%A8/"><img class="next_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>SpringBoot事务使用</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/12/11/@ContextConfiguration注解/" title="@ContextConfiguration注解"><img class="relatedPosts_cover lozad"data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><div class="relatedPosts_title">@ContextConfiguration注解</div></a></div><div class="relatedPosts_item"><a href="/2020/12/11/Filter VS Interceptor/" title="Filter VS Interceptor"><img class="relatedPosts_cover lozad"data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><div class="relatedPosts_title">Filter VS Interceptor</div></a></div><div class="relatedPosts_item"><a href="/2020/12/11/SpringBoot日志配置/" title="SpringBoot日志配置"><img class="relatedPosts_cover lozad"data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><div class="relatedPosts_title">SpringBoot日志配置</div></a></div><div class="relatedPosts_item"><a href="/2020/12/11/spring-boot-maven-plugin插件的作用/" title="spring-boot-maven-plugin插件的作用"><img class="relatedPosts_cover lozad"data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><div class="relatedPosts_title">spring-boot-maven-plugin插件的作用</div></a></div><div class="relatedPosts_item"><a href="/2020/12/11/Maven中的Resource配置/" title="Maven中的Resource配置"><img class="relatedPosts_cover lozad"data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><div class="relatedPosts_title">Maven中的Resource配置</div></a></div><div class="relatedPosts_item"><a href="/2020/12/11/SpringBoot事务使用/" title="SpringBoot事务使用"><img class="relatedPosts_cover lozad"data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><div class="relatedPosts_title">SpringBoot事务使用</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2020 By Huang Qingshan</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>