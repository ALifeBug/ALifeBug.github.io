<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>SpringSecurity整合JWT | ALifeBug</title><meta name="description" content="SpringSecurity整合JWT"><meta name="keywords" content="SpringSecurity"><meta name="author" content="Huang Qingshan"><meta name="copyright" content="Huang Qingshan"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://alifebug.github.io/2020/12/11/SpringSecurity%E6%95%B4%E5%90%88JWT/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SpringSecurity整合JWT"><meta name="twitter:description" content="SpringSecurity整合JWT"><meta name="twitter:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta property="og:type" content="article"><meta property="og:title" content="SpringSecurity整合JWT"><meta property="og:url" content="http://alifebug.github.io/2020/12/11/SpringSecurity%E6%95%B4%E5%90%88JWT/"><meta property="og:site_name" content="ALifeBug"><meta property="og:description" content="SpringSecurity整合JWT"><meta property="og:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="SpringSecurity全解析" href="http://alifebug.github.io/2020/12/11/SpringSecurity%E5%85%A8%E8%A7%A3%E6%9E%90/"><link rel="next" title="Volatile关键字解析" href="http://alifebug.github.io/2020/12/11/Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E8%A7%A3%E6%9E%90/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">ALifeBug</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">61</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">24</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#SpringSecurity整合JWT"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">SpringSecurity整合JWT</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Spring-Security的架构"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">Spring Security的架构</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#spring-security中核心概念"><span class="toc_mobile_items-number">1.1.0.1.</span> <span class="toc_mobile_items-text">spring-security中核心概念</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#对web系统的支持"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">对web系统的支持</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#JWT认证的实现"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">JWT认证的实现</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#项目搭建"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">项目搭建</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#gradle配置"><span class="toc_mobile_items-number">1.3.1.1.</span> <span class="toc_mobile_items-text">gradle配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#登录认证流程"><span class="toc_mobile_items-number">1.3.1.2.</span> <span class="toc_mobile_items-text">登录认证流程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#带Token请求校验流程"><span class="toc_mobile_items-number">1.3.1.3.</span> <span class="toc_mobile_items-text">带Token请求校验流程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#配置集成"><span class="toc_mobile_items-number">1.3.1.4.</span> <span class="toc_mobile_items-text">配置集成</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#角色配置"><span class="toc_mobile_items-number">1.3.1.5.</span> <span class="toc_mobile_items-text">角色配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#跨域支持"><span class="toc_mobile_items-number">1.3.1.6.</span> <span class="toc_mobile_items-text">跨域支持</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#总结"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">总结</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringSecurity整合JWT"><span class="toc-number">1.</span> <span class="toc-text">SpringSecurity整合JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security的架构"><span class="toc-number">1.1.</span> <span class="toc-text">Spring Security的架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#spring-security中核心概念"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">spring-security中核心概念</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#对web系统的支持"><span class="toc-number">1.2.</span> <span class="toc-text">对web系统的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT认证的实现"><span class="toc-number">1.3.</span> <span class="toc-text">JWT认证的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目搭建"><span class="toc-number">1.3.1.</span> <span class="toc-text">项目搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gradle配置"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">gradle配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#登录认证流程"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">登录认证流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#带Token请求校验流程"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">带Token请求校验流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置集成"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">配置集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#角色配置"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">角色配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#跨域支持"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">跨域支持</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">SpringSecurity整合JWT</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-12-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-12-11</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/SpringSecurity/">SpringSecurity</a></span><div class="post-meta-wordcount"><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="SpringSecurity整合JWT"><a href="#SpringSecurity整合JWT" class="headerlink" title="SpringSecurity整合JWT"></a>SpringSecurity整合JWT</h1><p>上一篇博客讲了如何使用Shiro和JWT做认证和授权（传送门：<a href="https://www.jianshu.com/p/0b1131be7ace" target="_blank" rel="noopener">https://www.jianshu.com/p/0b1131be7ace</a>），总的来说shiro是一个比较早期和简单的框架，这个从最近已经基本不做版本更新就可以看出来。这篇文章我们讲一下如何使用更加流行和完整的spring security来实现同样的需求。</p>
<h2 id="Spring-Security的架构"><a href="#Spring-Security的架构" class="headerlink" title="Spring Security的架构"></a>Spring Security的架构</h2><p>按照惯例，在使用之前我们先讲一下简单的架构。不知道是因为spring-security后出来还是因为优秀的设计殊途同归，对于核心模块，spring-security和shiro有80%以上的设计相似度。所以下面介绍中会多跟shiro做对比，如果你对shiro不了解也没关系，跟shiro对比的部分跳过就好。</p>
<h4 id="spring-security中核心概念"><a href="#spring-security中核心概念" class="headerlink" title="spring-security中核心概念"></a>spring-security中核心概念</h4><ul>
<li><p><strong>AuthenticationManager</strong>, 用户认证的管理类，所有的认证请求（比如login）都会通过提交一个token给<code>AuthenticationManager</code>的<code>authenticate()</code>方法来实现。当然事情肯定不是它来做，具体校验动作会由<code>AuthenticationManager</code>将请求转发给具体的实现类来做。根据实现反馈的结果再调用具体的Handler来给用户以反馈。这个类基本等同于shiro的<code>SecurityManager</code>。</p>
</li>
<li><p><strong>AuthenticationProvider</strong>, 认证的具体实现类，一个provider是一种认证方式的实现，比如提交的用户名密码我是通过和DB中查出的user记录做比对实现的，那就有一个<code>DaoProvider</code>；如果我是通过CAS请求单点登录系统实现，那就有一个<code>CASProvider</code>。这个是不是和shiro的Realm的定义很像？基本上你可以帮他们当成同一个东西。按照Spring一贯的作风，主流的认证方式它都已经提供了默认实现，比如DAO、LDAP、CAS、OAuth2等。<br>前面讲了<code>AuthenticationManager</code>只是一个代理接口，真正的认证就是由<code>AuthenticationProvider</code>来做的。一个<code>AuthenticationManager</code>可以包含多个Provider，每个provider通过实现一个support方法来表示自己支持那种Token的认证。<code>AuthenticationManager</code>默认的实现类是<code>ProviderManager</code>。</p>
</li>
<li><p><strong>UserDetailService</strong>, 用户认证通过Provider来做，所以Provider需要拿到系统已经保存的认证信息，获取用户信息的接口spring-security抽象成<code>UserDetailService</code>。虽然叫Service,但是我更愿意把它认为是我们系统里经常有的<code>UserDao</code>。</p>
</li>
<li><p><strong>AuthenticationToken</strong>,  所有提交给<code>AuthenticationManager</code>的认证请求都会被封装成一个Token的实现，比如最容易理解的<code>UsernamePasswordAuthenticationToken</code>。这个就不多讲了，连名字都跟Shiro中一样。</p>
</li>
<li><p><strong>SecurityContext</strong>，当用户通过认证之后，就会为这个用户生成一个唯一的<code>SecurityContext</code>，里面包含用户的认证信息<code>Authentication</code>。通过SecurityContext我们可以获取到用户的标识<code>Principle</code>和授权信息<code>GrantedAuthrity</code></p>
<p>在系统的任何地方只要通过<code>SecurityHolder.getSecruityContext()</code>就可以获取到<code>SecurityContext</code>在Shiro中通过</p>
<p><code>SecurityUtils.getSubject()</code>到达同样的目的。</p>
<p>我们大概通过一个认证流程来认识下上面几个关键的概念</p>
</li>
</ul>
<p>  <img alt="img" data-src="https:////upload-images.jianshu.io/upload_images/13282795-62fd0c22e989fa0c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/398/format/webp" class="lozad"></p>
<p>  认证流程</p>
<h2 id="对web系统的支持"><a href="#对web系统的支持" class="headerlink" title="对web系统的支持"></a>对web系统的支持</h2><p>毫无疑问，对于spring框架使用最多的还是web系统。对于web系统来说进入认证的最佳入口就是Filter了。spring security不仅实现了认证的逻辑，还通过filter实现了常见的web攻击的防护。<br> <strong>常用Filter</strong><br> 下面按照request进入的顺序列举一下常用的Filter：</p>
<ul>
<li>SecurityContextPersistenceFilter，用于将<code>SecurityContext</code>放入Session的Filter</li>
<li>UsernamePasswordAuthenticationFilter, 登录认证的Filter,类似的还有CasAuthenticationFilter，BasicAuthenticationFilter等等。在这些Filter中生成用于认证的token，提交到AuthenticationManager，如果认证失败会直接返回。</li>
<li>RememberMeAuthenticationFilter，通过cookie来实现remember me功能的Filter</li>
<li>AnonymousAuthenticationFilter，如果一个请求在到达这个filter之前SecurityContext没有初始化，则这个filter会默认生成一个匿名SecurityContext。这在支持匿名用户的系统中非常有用。</li>
<li>ExceptionTranslationFilter，捕获所有Spring Security抛出的异常，并决定处理方式</li>
<li>FilterSecurityInterceptor， 权限校验的拦截器，访问的url权限不足时会抛出异常<br> <strong>Filter的顺序</strong><br> 既然用了上面那么多filter，它们在FilterChain中的先后顺序就显得非常重要了。对于每一个系统或者用户自定义的filter，spring security都要求必须指定一个order，用来做排序。对于系统的filter的默认顺序，是在一个<code>FilterComparator</code>类中定义的，核心实现如下。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">FilterComparator() {</span><br><span class="line">    <span class="keyword">int</span> order = <span class="number">100</span>;</span><br><span class="line">    put(ChannelProcessingFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(ConcurrentSessionFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(WebAsyncManagerIntegrationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(SecurityContextPersistenceFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(HeaderWriterFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(CorsFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(CsrfFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(LogoutFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">        <span class="string">"org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter"</span>,</span><br><span class="line">        order);</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(X509AuthenticationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(AbstractPreAuthenticatedProcessingFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    filterToOrder.put(<span class="string">"org.springframework.security.cas.web.CasAuthenticationFilter"</span>,</span><br><span class="line">            order);</span><br><span class="line">    order += STEP;</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">        <span class="string">"org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter"</span>,</span><br><span class="line">        order);</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(ConcurrentSessionFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">            <span class="string">"org.springframework.security.openid.OpenIDAuthenticationFilter"</span>, order);</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(DefaultLoginPageGeneratingFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(ConcurrentSessionFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(DigestAuthenticationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(BasicAuthenticationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(RequestCacheAwareFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(SecurityContextHolderAwareRequestFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(JaasApiIntegrationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(RememberMeAuthenticationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(AnonymousAuthenticationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(SessionManagementFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(ExceptionTranslationFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(FilterSecurityInterceptor<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">    order += STEP;</span><br><span class="line">    put(SwitchUserFilter<span class="class">.<span class="keyword">class</span>, <span class="title">order</span>)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>对于用户自定义的filter，如果要加入spring security 的FilterChain中，必须指定加到已有的那个filter之前或者之后，具体下面我们用到自定义filter的时候会说明。</p>
<h2 id="JWT认证的实现"><a href="#JWT认证的实现" class="headerlink" title="JWT认证的实现"></a>JWT认证的实现</h2><p>关于使用JWT认证的原因，上一篇介绍Shiro的文章中已经说过了，这里不再多说。需求也还是那3个：</p>
<ul>
<li>支持用户通过用户名和密码登录</li>
<li>登录后通过http header返回token，每次请求，客户端需通过header将token带回，用于权限校验</li>
<li>服务端负责token的定期刷新<br> 下面我们直接进入Spring Secuiry的项目搭建。</li>
</ul>
<h3 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h3><h4 id="gradle配置"><a href="#gradle配置" class="headerlink" title="gradle配置"></a>gradle配置</h4><p>最新的spring项目开始默认使用gradle来做依赖管理了，所以这个项目也尝试下gradle的配置。除了springmvc和security的starter之外，还依赖了auth0的jwt工具包。JSON处理使用了fastjson。</p>
<figure class="highlight gradle"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> {</span><br><span class="line">    ext {</span><br><span class="line">        springBootVersion = <span class="string">'2.0.4.RELEASE'</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">repositories</span> {</span><br><span class="line">        mavenCentral()</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">dependencies</span> {</span><br><span class="line">        <span class="keyword">classpath</span>(<span class="string">"org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}"</span>)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">apply plugin: <span class="string">'java'</span></span><br><span class="line">apply plugin: <span class="string">'eclipse'</span></span><br><span class="line">apply plugin: <span class="string">'org.springframework.boot'</span></span><br><span class="line">apply plugin: <span class="string">'io.spring.dependency-management'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">group</span> = <span class="string">'com.github.springboot'</span></span><br><span class="line">version = <span class="string">'0.0.1-SNAPSHOT'</span></span><br><span class="line"><span class="keyword">sourceCompatibility</span> = <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">repositories</span> {</span><br><span class="line">    mavenCentral()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> {</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-security'</span>)    </span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.apache.commons:commons-lang3:3.8'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'com.auth0:java-jwt:3.4.0'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'com.alibaba:fastjson:1.2.47'</span>)</span><br><span class="line">    </span><br><span class="line">    testCompile(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>)</span><br><span class="line">    testCompile(<span class="string">'org.springframework.security:spring-security-test'</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="登录认证流程"><a href="#登录认证流程" class="headerlink" title="登录认证流程"></a>登录认证流程</h4><p><strong>Filter</strong><br> 对于用户登录行为，security通过定义一个Filter来拦截/login来实现的。spring security默认支持form方式登录，所以对于使用json发送登录信息的情况，我们自己定义一个Filter，这个Filter直接从<code>AbstractAuthenticationProcessingFilter</code>继承，只需要实现两部分，一个是RequestMatcher，指名拦截的Request类型；另外就是从json body中提取出username和password提交给AuthenticationManager。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUsernamePasswordAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyUsernamePasswordAuthenticationFilter</span><span class="params">()</span> </span>{</span><br><span class="line">         <span class="comment">//拦截url为 "/login" 的POST请求</span></span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(<span class="string">"/login"</span>, <span class="string">"POST"</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException, IOException, ServletException </span>{</span><br><span class="line">        <span class="comment">//从json中获取username和password</span></span><br><span class="line">        String body = StreamUtils.copyToString(request.getInputStream(), Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">        String username = <span class="keyword">null</span>, password = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(body)) {</span><br><span class="line">            JSONObject jsonObj = JSON.parseObject(body);</span><br><span class="line">            username = jsonObj.getString(<span class="string">"username"</span>);</span><br><span class="line">            password = jsonObj.getString(<span class="string">"password"</span>);</span><br><span class="line">        }   </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (username == <span class="keyword">null</span>) </span><br><span class="line">            username = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span> (password == <span class="keyword">null</span>)</span><br><span class="line">            password = <span class="string">""</span>;</span><br><span class="line">        username = username.trim();</span><br><span class="line">       <span class="comment">//封装到token中提交</span></span><br><span class="line">        UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">                username, password);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>Provider</strong><br> 前面的流程图中讲到了，封装后的token最终是交给provider来处理的。对于登录的provider，spring security已经提供了一个默认实现<code>DaoAuthenticationProvider</code>我们可以直接使用，这个类继承了<code>AbstractUserDetailsAuthenticationProvider</code>我们来看下关键部分的源代码是怎么做的。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUserDetailsAuthenticationProvider</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">AuthenticationProvider</span>, <span class="title">InitializingBean</span>, <span class="title">MessageSourceAware</span> </span>{</span><br><span class="line">...</span><br><span class="line">    <span class="comment">//这个方法返回true，说明支持该类型的token</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class<?> authentication)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> (UsernamePasswordAuthenticationToken<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">                .<span class="title">isAssignableFrom</span>(<span class="title">authentication</span>))</span>;</span><br><span class="line">   }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">             ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 获取系统中存储的用户信息</span></span><br><span class="line">                user = retrieveUser(username,</span><br><span class="line">                        (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">catch</span> (UsernameNotFoundException notFound) {</span><br><span class="line">                logger.debug(<span class="string">"User '"</span> + username + <span class="string">"' not found"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (hideUserNotFoundExceptions) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(messages.getMessage(</span><br><span class="line">                            <span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,</span><br><span class="line">                            <span class="string">"Bad credentials"</span>));</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> {</span><br><span class="line">                    <span class="keyword">throw</span> notFound;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">           <span class="comment">//检查user是否已过期或者已锁定</span></span><br><span class="line">            preAuthenticationChecks.check(user);</span><br><span class="line">           <span class="comment">//将获取到的用户信息和登录信息做比对</span></span><br><span class="line">            additionalAuthenticationChecks(user,</span><br><span class="line">                    (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (AuthenticationException exception) {</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">throw</span> exception;            </span><br><span class="line">        }</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//如果认证通过，则封装一个AuthenticationInfo, 放到SecurityContext中</span></span><br><span class="line">        <span class="keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上面的代码中，核心流程就是<code>retrieveUser()</code>获取系统中存储的用户信息，再对用户信息做了过期和锁定等校验后交给<code>additionalAuthenticationChecks()</code>和用户提交的信息做比对。<br> 这两个方法我们看他的继承类<code>DaoAuthenticationProvider</code>是怎么实现的。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoAuthenticationProvider</span> <span class="keyword">extends</span> <span class="title">AbstractUserDetailsAuthenticationProvider</span> </span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密密码比对</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">additionalAuthenticationChecks</span><span class="params">(UserDetails userDetails,</span></span></span><br><span class="line"><span class="function"><span class="params">            UsernamePasswordAuthenticationToken authentication)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        <span class="keyword">if</span> (authentication.getCredentials() == <span class="keyword">null</span>) {</span><br><span class="line">            logger.debug(<span class="string">"Authentication failed: no credentials provided"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(messages.getMessage(</span><br><span class="line">                    <span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,</span><br><span class="line">                    <span class="string">"Bad credentials"</span>));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        String presentedPassword = authentication.getCredentials().toString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!passwordEncoder.matches(presentedPassword, userDetails.getPassword())) {</span><br><span class="line">            logger.debug(<span class="string">"Authentication failed: password does not match stored value"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(messages.getMessage(</span><br><span class="line">                    <span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,</span><br><span class="line">                    <span class="string">"Bad credentials"</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 系统用户获取</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> UserDetails <span class="title">retrieveUser</span><span class="params">(String username,</span></span></span><br><span class="line"><span class="function"><span class="params">            UsernamePasswordAuthenticationToken authentication)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        prepareTimingAttackProtection();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            UserDetails loadedUser = <span class="keyword">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">            <span class="keyword">if</span> (loadedUser == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(</span><br><span class="line">                        <span class="string">"UserDetailsService returned null, which is an interface contract violation"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> loadedUser;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (UsernameNotFoundException ex) {</span><br><span class="line">            mitigateAgainstTimingAttack(authentication);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (InternalAuthenticationServiceException ex) {</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(ex.getMessage(), ex);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上面的方法实现中，用户获取是调用了<code>UserDetailsService</code>来完成的。这个是一个只有一个方法的接口，所以我们自己要做的，就是将自己的<code>UserDetailsService</code>实现类配置成一个Bean。下面是实例代码，真正的实现需要从数据库或者缓存中获取。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span></span>{</span><br><span class="line">    <span class="comment">//真实系统需要从数据库或缓存中获取，这里对密码做了加密</span></span><br><span class="line">     <span class="keyword">return</span> User.builder().username(<span class="string">"Jack"</span>).password(passwordEncoder.encode(<span class="string">"jack-password"</span>)).roles(<span class="string">"USER"</span>).build();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们再来看另外一个密码比对的方法，也是委托给一个<code>PasswordEncoder</code>类来实现的。一般来说，存在数据库中的密码都是要经过加密处理的，这样万一数据库数据被拖走，也不会泄露密码。spring一如既往的提供了主流的加密方式，如MD5,SHA等。如果不显示指定的话，Spring会默认使用<code>BCryptPasswordEncoder</code>，这个是目前相对比较安全的加密方式。具体介绍可参考spring-security 的官方文档 - <a href="https://docs.spring.io/spring-security/site/docs/5.0.7.RELEASE/reference/htmlsingle/#core-services-password-encoding" target="_blank" rel="noopener">Password Endcoding</a><br> <strong>认证结果处理</strong><br> filter将token交给provider做校验，校验的结果无非两种，成功或者失败。对于这两种结果，我们只需要实现两个Handler接口，set到Filter里面，Filter在收到Provider的处理结果后会回调这两个Handler的方法。<br> 先来看成功的情况，针对jwt认证的业务场景，登录成功需要返回给客户端一个token。所以成功的handler的实现类中需要包含这个逻辑。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonLoginSuccessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span></span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> JwtUserService jwtUserService;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonLoginSuccessHandler</span><span class="params">(JwtUserService jwtUserService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.jwtUserService = jwtUserService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">                <span class="comment">//生成token，并把token加密相关信息缓存，具体请看实现类</span></span><br><span class="line">        String token = jwtUserService.saveUserLoginInfo((UserDetails)authentication.getPrincipal());</span><br><span class="line">        response.setHeader(<span class="string">"Authorization"</span>, token);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>再来看失败的情况，登录失败比较简单，只需要回复一个401的Response即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpStatusLoginFailureHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationFailureHandler</span></span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">        response.setStatus(HttpStatus.UNAUTHORIZED.value());    </span><br><span class="line">    }   </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>JsonLoginConfigurer</strong><br> 以上整个登录的流程的组件就完整了，我们只需要把它们组合到一起就可以了。这里继承一个<code>AbstractHttpConfigurer</code>，对Filter做配置。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonLoginConfigurer</span><<span class="title">T</span> <span class="keyword">extends</span> <span class="title">JsonLoginConfigurer</span><<span class="title">T</span>, <span class="title">B</span>>, <span class="title">B</span> <span class="keyword">extends</span> <span class="title">HttpSecurityBuilder</span><<span class="title">B</span>>> <span class="keyword">extends</span> <span class="title">AbstractHttpConfigurer</span><<span class="title">T</span>, <span class="title">B</span>>  </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyUsernamePasswordAuthenticationFilter authFilter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonLoginConfigurer</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.authFilter = <span class="keyword">new</span> MyUsernamePasswordAuthenticationFilter();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(B http)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">//设置Filter使用的AuthenticationManager,这里取公共的即可</span></span><br><span class="line">        authFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        <span class="comment">//设置失败的Handler</span></span><br><span class="line">        authFilter.setAuthenticationFailureHandler(<span class="keyword">new</span> HttpStatusLoginFailureHandler());</span><br><span class="line">        <span class="comment">//不将认证后的context放入session</span></span><br><span class="line">        authFilter.setSessionAuthenticationStrategy(<span class="keyword">new</span> NullAuthenticatedSessionStrategy());</span><br><span class="line"></span><br><span class="line">        MyUsernamePasswordAuthenticationFilter filter = postProcess(authFilter);</span><br><span class="line">        <span class="comment">//指定Filter的位置</span></span><br><span class="line">        http.addFilterAfter(filter, LogoutFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//设置成功的Handler，这个handler定义成Bean，所以从外面set进来</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JsonLoginConfigurer<T,B> <span class="title">loginSuccessHandler</span><span class="params">(AuthenticationSuccessHandler authSuccessHandler)</span></span>{</span><br><span class="line">        authFilter.setAuthenticationSuccessHandler(authSuccessHandler);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这样Filter就完整的配置好了，当调用configure方法时，这个filter就会加入security FilterChain的指定位置。这个是在全局定义的地方，我们放在最后说。在全局配置的地方，也会将<code>DaoAuthenticationProvider</code>放到<code>ProviderManager</code>中，这样filter中提交的token就可以被处理了。</p>
<h4 id="带Token请求校验流程"><a href="#带Token请求校验流程" class="headerlink" title="带Token请求校验流程"></a>带Token请求校验流程</h4><p>用户除登录之外的请求，都要求必须携带JWT Token。所以我们需要另外一个Filter对这些请求做一个拦截。这个拦截器主要是提取header中的token，跟登录一样，提交给<code>AuthenticationManager</code>做检查。<br> <strong>Filter</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span></span>{</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtAuthenticationFilter</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">//拦截header中带Authorization的请求</span></span><br><span class="line">        <span class="keyword">this</span>.requiresAuthenticationRequestMatcher = <span class="keyword">new</span> RequestHeaderRequestMatcher(<span class="string">"Authorization"</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getJwtToken</span><span class="params">(HttpServletRequest request)</span> </span>{</span><br><span class="line">        String authInfo = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">return</span> StringUtils.removeStart(authInfo, <span class="string">"Bearer "</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>{</span><br><span class="line">       <span class="comment">//header没带token的，直接放过，因为部分url匿名用户也可以访问</span></span><br><span class="line">       <span class="comment">//如果需要不支持匿名用户的请求没带token，这里放过也没问题，因为SecurityContext中没有认证信息，后面会被权限控制模块拦截</span></span><br><span class="line">        <span class="keyword">if</span> (!requiresAuthentication(request, response)) {</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        Authentication authResult = <span class="keyword">null</span>;</span><br><span class="line">        AuthenticationException failed = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//从头中获取token并封装后提交给AuthenticationManager</span></span><br><span class="line">            String token = getJwtToken(request);</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isNotBlank(token)) {</span><br><span class="line">                JwtAuthenticationToken authToken = <span class="keyword">new</span> JwtAuthenticationToken(JWT.decode(token));               </span><br><span class="line">                authResult = <span class="keyword">this</span>.getAuthenticationManager().authenticate(authToken);</span><br><span class="line">            } <span class="keyword">else</span> {  <span class="comment">//如果token长度为0</span></span><br><span class="line">                failed = <span class="keyword">new</span> InsufficientAuthenticationException(<span class="string">"JWT is Empty"</span>);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span>(JWTDecodeException e) {</span><br><span class="line">            logger.error(<span class="string">"JWT format error"</span>, e);</span><br><span class="line">            failed = <span class="keyword">new</span> InsufficientAuthenticationException(<span class="string">"JWT format error"</span>, failed);</span><br><span class="line">        }<span class="keyword">catch</span> (InternalAuthenticationServiceException e) {</span><br><span class="line">            logger.error(</span><br><span class="line">                    <span class="string">"An internal error occurred while trying to authenticate the user."</span>,</span><br><span class="line">                    failed);</span><br><span class="line">            failed = e;</span><br><span class="line">        }<span class="keyword">catch</span> (AuthenticationException e) {</span><br><span class="line">            <span class="comment">// Authentication failed            </span></span><br><span class="line">            failed = e;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(authResult != <span class="keyword">null</span>) {   <span class="comment">//token认证成功</span></span><br><span class="line">            successfulAuthentication(request, response, filterChain, authResult);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span>(!permissiveRequest(request)){   </span><br><span class="line">            <span class="comment">//token认证失败，并且这个request不在例外列表里，才会返回错误</span></span><br><span class="line">            unsuccessfulAuthentication(request, response, failed);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">requiresAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletResponse response)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> requiresAuthenticationRequestMatcher.matches(request);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">permissiveRequest</span><span class="params">(HttpServletRequest request)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span>(permissiveRequestMatchers == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span>(RequestMatcher permissiveMatcher : permissiveRequestMatchers) {</span><br><span class="line">            <span class="keyword">if</span>(permissiveMatcher.matches(request))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }       </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个Filter的实现跟登录的Filter有几点区别：</p>
<ul>
<li>经过这个Filter的请求，会继续过<code>FilterChain</code>中的其它Filter。因为跟登录请求不一样，token只是为了识别用户。</li>
<li>如果header中没有认证信息或者认证失败，还会判断请求的url是否强制认证的（通过<code>permissiveRequest</code>方法判断）。如果请求不是强制认证，也会放过，这种情况比如博客类应用匿名用户访问查看页面；比如登出操作，如果未登录用户点击登出，我们一般是不会报错的。<br> 其它逻辑跟登录一样，组装一个token提交给<code>AuthenticationManager</code>。</li>
</ul>
<p><strong>JwtAuthenticationProvider</strong><br> 同样我们需要一个provider来接收jwt的token，在收到token请求后，会从数据库或者缓存中取出salt，对token做验证，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span></span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> JwtUserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtAuthenticationProvider</span><span class="params">(JwtUserService userService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        DecodedJWT jwt = ((JwtAuthenticationToken)authentication).getToken();</span><br><span class="line">        <span class="keyword">if</span>(jwt.getExpiresAt().before(Calendar.getInstance().getTime()))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NonceExpiredException(<span class="string">"Token expires"</span>);</span><br><span class="line">        String username = jwt.getSubject();</span><br><span class="line">        UserDetails user = userService.getUserLoginInfo(username);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span> || user.getPassword()==<span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NonceExpiredException(<span class="string">"Token expires"</span>);</span><br><span class="line">        String encryptSalt = user.getPassword();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Algorithm algorithm = Algorithm.HMAC256(encryptSalt);</span><br><span class="line">            JWTVerifier verifier = JWT.require(algorithm)</span><br><span class="line">                    .withSubject(username)</span><br><span class="line">                    .build();</span><br><span class="line">            verifier.verify(jwt.getToken());</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">"JWT token verify fail"</span>, e);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//成功后返回认证信息，filter会将认证信息放入SecurityContext</span></span><br><span class="line">        JwtAuthenticationToken token = <span class="keyword">new</span> JwtAuthenticationToken(user, jwt, user.getAuthorities());</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class<?> authentication)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> authentication.isAssignableFrom(JwtAuthenticationToken<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>认证结果Handler</strong><br> 如果token认证失败，并且不在permissive列表中话，就会调用FailHandler，这个Handler和登录行为一致，所以都使用<code>HttpStatusLoginFailureHandler</code> 返回401错误。<br> token认证成功，在继续FilterChain中的其它Filter之前，我们先检查一下token是否需要刷新，刷新成功后会将新token放入header中。所以，新增一个<code>JwtRefreshSuccessHandler</code>来处理token认证成功的情况。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtRefreshSuccessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span></span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> tokenRefreshInterval = <span class="number">300</span>;  <span class="comment">//刷新间隔5分钟</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> JwtUserService jwtUserService;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtRefreshSuccessHandler</span><span class="params">(JwtUserService jwtUserService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.jwtUserService = jwtUserService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">        DecodedJWT jwt = ((JwtAuthenticationToken)authentication).getToken();</span><br><span class="line">        <span class="keyword">boolean</span> shouldRefresh = shouldTokenRefresh(jwt.getIssuedAt());</span><br><span class="line">        <span class="keyword">if</span>(shouldRefresh) {</span><br><span class="line">            String newToken = jwtUserService.saveUserLoginInfo((UserDetails)authentication.getPrincipal());</span><br><span class="line">            response.setHeader(<span class="string">"Authorization"</span>, newToken);</span><br><span class="line">        }   </span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">shouldTokenRefresh</span><span class="params">(Date issueAt)</span></span>{</span><br><span class="line">        LocalDateTime issueTime = LocalDateTime.ofInstant(issueAt.toInstant(), ZoneId.systemDefault());</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().minusSeconds(tokenRefreshInterval).isAfter(issueTime);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>JwtLoginConfigurer</strong><br> 跟登录逻辑一样，我们定义一个configurer，用来初始化和配置JWTFilter。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtLoginConfigurer</span><<span class="title">T</span> <span class="keyword">extends</span> <span class="title">JwtLoginConfigurer</span><<span class="title">T</span>, <span class="title">B</span>>, <span class="title">B</span> <span class="keyword">extends</span> <span class="title">HttpSecurityBuilder</span><<span class="title">B</span>>> <span class="keyword">extends</span> <span class="title">AbstractHttpConfigurer</span><<span class="title">T</span>, <span class="title">B</span>> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> JwtAuthenticationFilter authFilter;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtLoginConfigurer</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.authFilter = <span class="keyword">new</span> JwtAuthenticationFilter();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(B http)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        authFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        authFilter.setAuthenticationFailureHandler(<span class="keyword">new</span> HttpStatusLoginFailureHandler());</span><br><span class="line">        <span class="comment">//将filter放到logoutFilter之前</span></span><br><span class="line">        JwtAuthenticationFilter filter = postProcess(authFilter);</span><br><span class="line">        http.addFilterBefore(filter, LogoutFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//设置匿名用户可访问url</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtLoginConfigurer<T, B> <span class="title">permissiveRequestUrls</span><span class="params">(String ... urls)</span></span>{</span><br><span class="line">        authFilter.setPermissiveUrl(urls);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtLoginConfigurer<T, B> <span class="title">tokenValidSuccessHandler</span><span class="params">(AuthenticationSuccessHandler successHandler)</span></span>{</span><br><span class="line">        authFilter.setAuthenticationSuccessHandler(successHandler);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置集成"><a href="#配置集成" class="headerlink" title="配置集成"></a>配置集成</h4><p>整个登录和无状态用户认证的流程都已经讲完了，现在我们需要吧spring security集成到我们的web项目中去。spring security和spring mvc做了很好的集成，一共只需要做两件事，给web配置类加上<code>@EanbleWebSecurity</code>，继承<code>WebSecurityConfigurerAdapter</code>定义个性化配置。<br> <strong>配置类WebSecurityConfig</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/image/**"</span>).permitAll() <span class="comment">//静态资源访问无需认证</span></span><br><span class="line">                .antMatchers(<span class="string">"/admin/**"</span>).hasAnyRole(<span class="string">"ADMIN"</span>) <span class="comment">//admin开头的请求，需要admin权限</span></span><br><span class="line">                .antMatchers(<span class="string">"/article/**"</span>).hasRole(<span class="string">"USER"</span>) <span class="comment">//需登陆才能访问的url</span></span><br><span class="line">                .anyRequest().authenticated()  <span class="comment">//默认其它的请求都需要认证，这里一定要添加</span></span><br><span class="line">                .and()</span><br><span class="line">            .csrf().disable()  <span class="comment">//CRSF禁用，因为不使用session</span></span><br><span class="line">            .sessionManagement().disable()  <span class="comment">//禁用session</span></span><br><span class="line">            .formLogin().disable() <span class="comment">//禁用form登录</span></span><br><span class="line">            .cors()  <span class="comment">//支持跨域</span></span><br><span class="line">            .and()   <span class="comment">//添加header设置，支持跨域和ajax请求</span></span><br><span class="line">            .headers().addHeaderWriter(<span class="keyword">new</span> StaticHeadersWriter(Arrays.asList(</span><br><span class="line">                    <span class="keyword">new</span> Header(<span class="string">"Access-control-Allow-Origin"</span>,<span class="string">"*"</span>),</span><br><span class="line">                    <span class="keyword">new</span> Header(<span class="string">"Access-Control-Expose-Headers"</span>,<span class="string">"Authorization"</span>))))</span><br><span class="line">            .and() <span class="comment">//拦截OPTIONS请求，直接返回header</span></span><br><span class="line">            .addFilterAfter(<span class="keyword">new</span> OptionRequestFilter(), CorsFilter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">            //添加登录<span class="title">filter</span></span></span><br><span class="line"><span class="class">            .<span class="title">apply</span>(<span class="title">new</span> <span class="title">JsonLoginConfigurer</span><>()).<span class="title">loginSuccessHandler</span>(<span class="title">jsonLoginSuccessHandler</span>())</span></span><br><span class="line"><span class="class">            .<span class="title">and</span>()</span></span><br><span class="line"><span class="class">           //添加<span class="title">token</span>的<span class="title">filter</span></span></span><br><span class="line">            .apply(new JwtLoginConfigurer<>()).tokenValidSuccessHandler(jwtRefreshSuccessHandler()).permissiveRequestUrls("/logout")</span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">//使用默认的logoutFilter</span></span><br><span class="line">            .logout()</span><br><span class="line"><span class="comment">//              .logoutUrl("/logout")   //默认就是"/logout"</span></span><br><span class="line">                .addLogoutHandler(tokenClearLogoutHandler())  <span class="comment">//logout时清除token</span></span><br><span class="line">                .logoutSuccessHandler(<span class="keyword">new</span> HttpStatusReturningLogoutSuccessHandler()) <span class="comment">//logout成功后返回200</span></span><br><span class="line">            .and()</span><br><span class="line">            .sessionManagement().disable();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//配置provider</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        auth.authenticationProvider(daoAuthenticationProvider()).authenticationProvider(jwtAuthenticationProvider());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"jwtAuthenticationProvider"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationProvider <span class="title">jwtAuthenticationProvider</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtAuthenticationProvider(jwtUserService());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"daoAuthenticationProvider"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationProvider <span class="title">daoAuthenticationProvider</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">        <span class="comment">//这里会默认使用BCryptPasswordEncoder比对加密后的密码，注意要跟createUser时保持一致</span></span><br><span class="line">        DaoAuthenticationProvider daoProvider = <span class="keyword">new</span> DaoAuthenticationProvider();</span><br><span class="line">        daoProvider.setUserDetailsService(userDetailsService());</span><br><span class="line">        <span class="keyword">return</span> daoProvider;</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以上的配置类主要关注一下几个点：</p>
<ul>
<li>访问权限配置，使用url匹配是放过还是需要角色和认证</li>
<li>跨域支持，这个我们下面再讲</li>
<li>禁用csrf，csrf攻击是针对使用session的情况，这里是不需要的，关于CSRF可参考 <a href="https://docs.spring.io/spring-security/site/docs/5.0.7.RELEASE/reference/htmlsingle/#csrf" target="_blank" rel="noopener">Cross Site Request Forgery</a> </li>
<li>禁用默认的form登录支持</li>
<li>logout支持，spring security已经默认支持logout filter，会拦截/logout请求，交给logoutHandler处理，同时在logout成功后调用<code>LogoutSuccessHandler</code>。对于logout，我们需要清除保存的token salt信息，这样再拿logout之前的token访问就会失败。请参考TokenClearLogoutHandler：</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenClearLogoutHandler</span> <span class="keyword">implements</span> <span class="title">LogoutHandler</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> JwtUserService jwtUserService;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TokenClearLogoutHandler</span><span class="params">(JwtUserService jwtUserService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.jwtUserService = jwtUserService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> </span>{</span><br><span class="line">        clearToken(authentication);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">clearToken</span><span class="params">(Authentication authentication)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span>(authentication == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        UserDetails user = (UserDetails)authentication.getPrincipal();</span><br><span class="line">        <span class="keyword">if</span>(user!=<span class="keyword">null</span> && user.getUsername()!=<span class="keyword">null</span>)</span><br><span class="line">            jwtUserService.deleteUserLoginInfo(user.getUsername());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="角色配置"><a href="#角色配置" class="headerlink" title="角色配置"></a>角色配置</h4><p>Spring Security对于访问权限的检查主要是通过<code>AbstractSecurityIntercepter</code>来实现，进入这个拦截器的基础一定是在context有有效的Authentication。<br> 回顾下上面实现的<code>UserDetailsService</code>，在登录或token认证时返回的<code>Authentication</code>包含了<code>GrantedAuthority</code>的列表。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>{</span><br><span class="line">        <span class="comment">//调用roles("USER")会将USER角色加入GrantedAuthority</span></span><br><span class="line">        <span class="keyword">return</span> User.builder().username(<span class="string">"Jack"</span>).password(passwordEncoder.encode(<span class="string">"jack-password"</span>)).roles(<span class="string">"USER"</span>).build();  </span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>然后我们上面的配置类中有对url的role做了配置。比如下面的配置表示/admin开头的url支持有admin和manager权限的用户访问：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(<span class="string">"/admin/**"</span>).hasAnyRole(<span class="string">"ADMIN,MANAGER"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>对于Intecepter来说只需要吧配置中的信息和<code>GrantedAuthority</code>的信息一起提交给<code>AccessDecisionManager</code>来做比对。</p>
<h4 id="跨域支持"><a href="#跨域支持" class="headerlink" title="跨域支持"></a>跨域支持</h4><p>前后端分离的项目需要支持跨域请求，需要做下面的配置。<br> <strong>CORS配置</strong><br> 首先需要在HttpSecurity配置中启用cors支持</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.cors()</span><br></pre></td></tr></tbody></table></figure>

<p>这样spring security就会从<code>CorsConfigurationSource</code>中取跨域配置，所以我们需要定义一个Bean:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> CorsConfigurationSource <span class="title">corsConfigurationSource</span><span class="params">()</span> </span>{</span><br><span class="line">        CorsConfiguration configuration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        configuration.setAllowedOrigins(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        configuration.setAllowedMethods(Arrays.asList(<span class="string">"GET"</span>,<span class="string">"POST"</span>,<span class="string">"HEAD"</span>, <span class="string">"OPTION"</span>));</span><br><span class="line">        configuration.setAllowedHeaders(Arrays.asList(<span class="string">"*"</span>));</span><br><span class="line">        configuration.addExposedHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">"/**"</span>, configuration);</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>Header配置</strong><br> 对于返回给浏览器的Response的Header也需要添加跨域配置：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http..headers().addHeaderWriter(<span class="keyword">new</span> StaticHeadersWriter(Arrays.asList(</span><br><span class="line">         <span class="comment">//支持所有源的访问</span></span><br><span class="line">        <span class="keyword">new</span> Header(<span class="string">"Access-control-Allow-Origin"</span>,<span class="string">"*"</span>),</span><br><span class="line">         <span class="comment">//使ajax请求能够取到header中的jwt token信息</span></span><br><span class="line">        <span class="keyword">new</span> Header(<span class="string">"Access-Control-Expose-Headers"</span>,<span class="string">"Authorization"</span>))))</span><br></pre></td></tr></tbody></table></figure>

<p><strong>OPTIONS请求配置</strong><br> 对于ajax的跨域请求，浏览器在发送真实请求之前，会向服务端发送OPTIONS请求，看服务端是否支持。对于options请求我们只需要返回header，不需要再进其它的filter，所以我们加了一个<code>OptionsRequestFilter</code>，填充header后就直接返回：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OptionsRequestFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>{</span><br><span class="line">        <span class="keyword">if</span>(request.getMethod().equals(<span class="string">"OPTIONS"</span>)) {</span><br><span class="line">            response.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET,POST,OPTIONS,HEAD"</span>);</span><br><span class="line">            response.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, response.getHeader(<span class="string">"Access-Control-Request-Headers"</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Spring Security在和shiro使用了类似的认证核心设计的情况下，提供了更多的和web的整合，以及更丰富的第三方认证支持。同时在安全性方面，也提供了足够多的默认支持，对得上security这个名字。<br> 所以这两个框架的选择问题就相对简单了：<br> 1）如果系统中本来使用了spring，那优先选择spring security；<br> 2）如果是web系统，spring security提供了更多的安全性支持<br> 3）除次之外可以选择shiro</p>
<p>文章内使用的源码已经放在git上：<a href="https://github.com/chilexun/springboot-demo/tree/master/security-jwt-demo" target="_blank" rel="noopener">Spring Security and JWT demo</a></p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Huang Qingshan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://alifebug.github.io/2020/12/11/SpringSecurity%E6%95%B4%E5%90%88JWT/">http://alifebug.github.io/2020/12/11/SpringSecurity%E6%95%B4%E5%90%88JWT/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://ALifeBug.github.io">ALifeBug</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringSecurity/">SpringSecurity    </a></div><div class="post_share"><div class="social-share" data-image="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.png"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.png"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/11/SpringSecurity%E5%85%A8%E8%A7%A3%E6%9E%90/"><img class="prev_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>SpringSecurity全解析</span></div></a></div><div class="next-post pull-right"><a href="/2020/12/11/Volatile%E5%85%B3%E9%94%AE%E5%AD%97%E8%A7%A3%E6%9E%90/"><img class="next_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Volatile关键字解析</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/12/11/SpringSecurity全解析/" title="SpringSecurity全解析"><img class="relatedPosts_cover lozad"data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><div class="relatedPosts_title">SpringSecurity全解析</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2020 By Huang Qingshan</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>