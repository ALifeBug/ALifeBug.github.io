<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>JVM调优 | ALifeBug</title><meta name="description" content="JVM调优"><meta name="keywords" content="JVM"><meta name="author" content="Huang Qingshan"><meta name="copyright" content="Huang Qingshan"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://alifebug.github.io/2020/12/11/JVM%E8%B0%83%E4%BC%98/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="JVM调优"><meta name="twitter:description" content="JVM调优"><meta name="twitter:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta property="og:type" content="article"><meta property="og:title" content="JVM调优"><meta property="og:url" content="http://alifebug.github.io/2020/12/11/JVM%E8%B0%83%E4%BC%98/"><meta property="og:site_name" content="ALifeBug"><meta property="og:description" content="JVM调优"><meta property="og:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="Crontab" href="http://alifebug.github.io/2020/12/11/Crontab/"><link rel="next" title="Java的多态性" href="http://alifebug.github.io/2020/12/11/Java%E7%9A%84%E5%A4%9A%E6%80%81%E6%80%A7/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">ALifeBug</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">61</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">24</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#JVM调优"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">JVM调优</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#JVM基础：生产环境参数实例及分析"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">JVM基础：生产环境参数实例及分析</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#JVM调优"><span class="toc-number">1.</span> <span class="toc-text">JVM调优</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM基础：生产环境参数实例及分析"><span class="toc-number">1.1.</span> <span class="toc-text">JVM基础：生产环境参数实例及分析</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">JVM调优</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-12-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-12-11</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/JVM/">JVM</a></span><div class="post-meta-wordcount"><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="JVM调优"><a href="#JVM调优" class="headerlink" title="JVM调优"></a>JVM调优</h1><h2 id="JVM基础：生产环境参数实例及分析"><a href="#JVM基础：生产环境参数实例及分析" class="headerlink" title="JVM基础：生产环境参数实例及分析"></a>JVM基础：生产环境参数实例及分析</h2><p> <strong>原始配置：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-Xms128m</span>  <span class="string"></span></span><br><span class="line"><span class="meta">-Xmx128m</span>  <span class="string"></span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">NewSize=64m  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">PermSize=64m  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseConcMarkSweepGC  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">CMSInitiatingOccupancyFraction=78 </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">ThreadStackSize=128k</span></span><br><span class="line"><span class="meta">-Xloggc</span>:<span class="string">logs/gc.log  </span></span><br><span class="line"><span class="meta">-Dsun.rmi.dgc.server.gcInterval</span>=<span class="string">3600000 </span></span><br><span class="line"><span class="meta">-Dsun.rmi.dgc.client.gcInterval</span>=<span class="string">3600000 </span></span><br><span class="line"><span class="meta">-Dsun.rmi.server.exceptionTrace</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>问题：</p>
<p>◆  permsize 设置较小,很容易达到报警范围(0.8)</p>
<p>◆ 没有设置MaxPermSize，堆增长会带来额外压力。</p>
<p>◆ NewSize较大，old gen 剩余空间64m，一方面可能会带来old区容易增长到报警范围（监控数据显示oldgenused长期在50m左右，接近78%，容易出现full gc），另一方面也存在promontion fail风险。</p>
<p>Jvm内存调优：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-Xms128m  </span><br><span class="line">-Xmx128m  </span><br><span class="line">-Xmn24m  </span><br><span class="line">-XX:PermSize=<span class="number">80</span>m  </span><br><span class="line">-XX:MaxPermSize=<span class="number">80</span>m  </span><br><span class="line">-Xss256k-XX:SurvivorRatio=<span class="number">1</span> </span><br><span class="line">-XX:MaxTenuringThreshold=<span class="number">20</span> </span><br><span class="line">-XX:+UseParNewGC  </span><br><span class="line">-XX:+UseConcMarkSweepGC  </span><br><span class="line">-XX:CMSInitiatingOccupancyFraction=<span class="number">75</span> </span><br><span class="line">-XX:+UseCMSCompactAtFullCollection  </span><br><span class="line">-XX:+CMSParallelRemarkEnabled  </span><br><span class="line">-XX:CMSFullGCsBeforeCompaction=<span class="number">2</span> </span><br><span class="line">-XX:SoftRefLRUPolicyMSPerMB=<span class="number">0</span> </span><br><span class="line">-XX:+PrintClassHistogram  </span><br><span class="line">-XX:+PrintGCDetails  </span><br><span class="line">-XX:+PrintGCTimeStamps  </span><br><span class="line">-XX:+PrintHeapAtGC  </span><br><span class="line">-Xloggc:logs/gc.log  </span><br><span class="line">-Dsun.rmi.dgc.server.gcInterval=<span class="number">3600000</span> </span><br><span class="line">-Dsun.rmi.dgc.client.gcInterval=<span class="number">3600000</span> </span><br><span class="line">-Dsun.rmi.server.exceptionTrace=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>修改点：</p>
<p>◆ PermSize与MaxPermSize都设置为80，一方面避免non heap warn(报警阀值0.8 非对内存一般占用到60M以内），一方面避免堆伸缩带来的压力</p>
<p>◆ 通过设置Xmn=24M及SurvivorRatio=1 使得Eden区=from space=to space=8M,降低了Eden区大小，降低YGC的时间(降低到3-4ms左右),同时通过设MaxTenuringThreshold=20，使得old gen的增长很缓慢。带来的问题是YGC的次数明显提高了很多。</p>
<p>◆ 其他参数优化 修改后带来的好处见另一篇文章对参数的详细介绍</p>
<p> 再次进行内存调优：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">-Xms128m  </span><br><span class="line">-Xmx128m  </span><br><span class="line">-Xmn36m  </span><br><span class="line">-XX:PermSize=<span class="number">80</span>m  </span><br><span class="line">-XX:MaxPermSize=<span class="number">80</span>m  </span><br><span class="line">-Xss256k  </span><br><span class="line">-XX:SurvivorRatio=<span class="number">1</span> </span><br><span class="line">-XX:MaxTenuringThreshold=<span class="number">20</span> </span><br><span class="line">-XX:+UseParNewGC  </span><br><span class="line">-XX:+UseConcMarkSweepGC  </span><br><span class="line">-XX:CMSInitiatingOccupancyFraction=<span class="number">73</span> </span><br><span class="line">-XX:+UseCMSCompactAtFullCollection  </span><br><span class="line">-XX:+CMSParallelRemarkEnabled  </span><br><span class="line">-XX:CMSFullGCsBeforeCompaction=<span class="number">2</span> </span><br><span class="line">-XX:SoftRefLRUPolicyMSPerMB=<span class="number">0</span> </span><br><span class="line">-XX:+PrintClassHistogram  </span><br><span class="line">-XX:+PrintGCDetails  </span><br><span class="line">-XX:+PrintGCTimeStamps  </span><br><span class="line">-XX:+PrintHeapAtGC  </span><br><span class="line">-Xloggc:logs/gc.log  </span><br><span class="line">-Dsun.rmi.dgc.server.gcInterval=<span class="number">3600000</span> </span><br><span class="line">-Dsun.rmi.dgc.client.gcInterval=<span class="number">3600000</span> </span><br><span class="line">-Dsun.rmi.server.exceptionTrace=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>修改点：</p>
<p>在上面的基础上调整Xmn大小到36M，设置CMSInitiatingOccupancyFraction=73。</p>
<p>Dden区与Survivor区大小都增加到12M，通过<a href="http://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html#CMSInitiatingOccupancyFraction_value" target="_blank" rel="noopener">CMSInitiatingOccupancyFraction计算公式</a>,计算得出value为73是，可以避免promotion faild问题，因为 年老去的大小为 (128m - 36m)0*（1-0.73） = 24.86m  完全可以放一下一个Eden区的大小；</p>
<p>同时满足堆内存监控报警值在80%：内存大小128M<em>80%=102.4M， 102.4M-36M=66.4M (老生代达到此值也会报警 老生代达到92M</em>0.73 =67.15M）将发生Full GC，所以在老生代大小达到66.4M时也就是WARN报警时将很有可能出现Full GC。</p>
<p>增大了Eden和Survivor区的值，会减小YGC的次数，但由于空间变大理论上也会相应的增加YGC的时间，不过由于新生代本身就很小（才36M）这点儿变化可以忽略掉。实际的监控值显示YGC的时间在4-5ms之间。是可以接受范围。</p>
<p>SurvivorRatio 这个值还得在仔细考虑下,有待优化中。</p>
<p><strong>网上某个牛人的配置 :每天几百万pv一点问题都没有，网站没有停顿</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$JAVA_ARGS  </span><br><span class="line">.=<span class="string">"  </span></span><br><span class="line"><span class="string">-Dresin.home=$SERVER_ROOT  </span></span><br><span class="line"><span class="string">-server  </span></span><br><span class="line"><span class="string">-Xms6000M  </span></span><br><span class="line"><span class="string">-Xmx6000M  </span></span><br><span class="line"><span class="string">-Xmn500M  </span></span><br><span class="line"><span class="string">-XX:PermSize=500M  </span></span><br><span class="line"><span class="string">-XX:MaxPermSize=500M  </span></span><br><span class="line"><span class="string">-XX:SurvivorRatio=65536 </span></span><br><span class="line"><span class="string">-XX:MaxTenuringThreshold=0 </span></span><br><span class="line"><span class="string">-Xnoclassgc  </span></span><br><span class="line"><span class="string">-XX:+DisableExplicitGC  </span></span><br><span class="line"><span class="string">-XX:+UseParNewGC  </span></span><br><span class="line"><span class="string">-XX:+UseConcMarkSweepGC  </span></span><br><span class="line"><span class="string">-XX:+UseCMSCompactAtFullCollection  </span></span><br><span class="line"><span class="string">-XX:CMSFullGCsBeforeCompaction=0 </span></span><br><span class="line"><span class="string">-XX:+CMSClassUnloadingEnabled-XX:  </span></span><br><span class="line"><span class="string">-CMSParallelRemarkEnabled  </span></span><br><span class="line"><span class="string">-XX:CMSInitiatingOccupancyFraction=90 </span></span><br><span class="line"><span class="string">-XX:SoftRefLRUPolicyMSPerMB=0 </span></span><br><span class="line"><span class="string">-XX:+PrintClassHistogram  </span></span><br><span class="line"><span class="string">-XX:+PrintGCDetails  </span></span><br><span class="line"><span class="string">-XX:+PrintGCTimeStamps  </span></span><br><span class="line"><span class="string">-XX:+PrintHeapAtGC  </span></span><br><span class="line"><span class="string">-Xloggc:log/gc.log  </span></span><br><span class="line"><span class="string">"</span>;</span><br></pre></td></tr></table></figure>

<p>该调优设置中：</p>
<p>-XX:SurvivorRatio=65536  -XX:MaxTenuringThreshold=0  目的就是去掉了救助空间 也就是年轻代中只有Eden区 Eden的对象 会直接到年老区中；</p>
<p>-Xnoclassgc 禁用类垃圾回收，性能会高一点；</p>
<p>-XX:+DisableExplicitGC禁止System.gc()，免得程序员误调用gc方法影响性能；</p>
<p>-XX:+UseParNewGC，对年轻代采用多线程并行回收，这样收得快；</p>
<p>带CMS（并发收集算法）参数的都是和并发回收相关的，不明白的可以上网搜索；</p>
<p>CMSInitiatingOccupancyFraction，这个参数设置有很大技巧，基本上满足如下公式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Xmx-Xmn)*(<span class="number">100</span>-CMSInitiatingOccupancyFraction)/<span class="number">100</span>&gt;=Xmn</span><br></pre></td></tr></table></figure>

<p> 就不会出现promotion failed；</p>
<p>在我的应用中Xmx是6000，Xmn是500，那么Xmx-Xmn是5500兆，也就是年老代有5500兆，CMSInitiatingOccupancyFraction=90说明年老代到90%满的时候开始执行对年老代的并发垃圾回收（CMS），这时还剩10%的空间是5500*10%=550兆，所以即使Xmn（也就是年轻代共500兆）里所有对象都搬到年老代里，550兆的空间也足够了，所以只要满足上面的公式，就不会出现垃圾回收时的promotion failed；</p>
<p>SoftRefLRUPolicyMSPerMB这个参数我认为可能有点用，官方解释是softly reachable objects will remain alive for some amount of time after the last time they were referenced. The default value is one second of lifetime per free megabyte in the heap，我觉得没必要等1秒；</p>
<p> <strong>继续进行jvm调优：</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-Xmx4000M</span>  <span class="string"></span></span><br><span class="line"><span class="meta">-Xms4000M</span>  <span class="string"></span></span><br><span class="line"><span class="meta">-Xmn600M</span>  <span class="string"></span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">PermSize=500M  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">MaxPermSize=500M  </span></span><br><span class="line"><span class="meta">-Xss256K</span>  <span class="string"></span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+DisableExplicitGC  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">SurvivorRatio=1 </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseConcMarkSweepGC  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseParNewGC  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+CMSParallelRemarkEnabled  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseCMSCompactAtFullCollection  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">CMSFullGCsBeforeCompaction=0 </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+CMSClassUnloadingEnabled  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">LargePageSizeInBytes=128M  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseFastAccessorMethods  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseCMSInitiatingOccupancyOnly  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">CMSInitiatingOccupancyFraction=80 </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">SoftRefLRUPolicyMSPerMB=0 </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+PrintClassHistogram  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+PrintGCDetails  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+PrintGCTimeStamps  </span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+PrintHeapAtGC  </span></span><br><span class="line"><span class="meta">-Xloggc</span>:<span class="string">log/gc.log</span></span><br></pre></td></tr></table></figure>

<p>改进说明:</p>
<p>第一次的调优方法不太好，因为没有用到救助空间，所以年老代容易满，CMS执行会比较频繁（年老代进行一次GC 则年轻代也要及进行一次GC 想当于一次Full GC）。我改善了一下，还是用救助空间，但是把救助空间加大，这样也不会有promotion failed。<br>具体操作上，32位Linux和64位Linux好像不一样，64位系统似乎只要配置MaxTenuringThreshold参数，CMS还是有暂停。为了解决暂停问题和promotion failed问题，最后我设置-XX:SurvivorRatio=1 ，并把MaxTenuringThreshold去掉，这样即没有暂停又不会有promotoin failed，而且更重要的是，年老代和永久代上升非常慢（因为好多对象到不了年老代就被回收了），所以CMS执行频率非常低，好几个小时才执行一次，这样，服务器都不用重启了。</p>
<p><strong>某网友的调优方案：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$JAVA_ARGS  </span><br><span class="line">.=<span class="string">"  </span></span><br><span class="line"><span class="string">-Dresin.home=$SERVER_ROOT  </span></span><br><span class="line"><span class="string">-server  </span></span><br><span class="line"><span class="string">-Xmx3000M  </span></span><br><span class="line"><span class="string">-Xms3000M  </span></span><br><span class="line"><span class="string">-Xmn600M  </span></span><br><span class="line"><span class="string">-XX:PermSize=500M  </span></span><br><span class="line"><span class="string">-XX:MaxPermSize=500M  </span></span><br><span class="line"><span class="string">-Xss256K  </span></span><br><span class="line"><span class="string">-XX:+DisableExplicitGC  </span></span><br><span class="line"><span class="string">-XX:SurvivorRatio=1 </span></span><br><span class="line"><span class="string">-XX:+UseConcMarkSweepGC  </span></span><br><span class="line"><span class="string">-XX:+UseParNewGC  </span></span><br><span class="line"><span class="string">-XX:+CMSParallelRemarkEnabled  </span></span><br><span class="line"><span class="string">-XX:+UseCMSCompactAtFullCollection  </span></span><br><span class="line"><span class="string">-XX:CMSFullGCsBeforeCompaction=0 </span></span><br><span class="line"><span class="string">-XX:+CMSClassUnloadingEnabled  </span></span><br><span class="line"><span class="string">-XX:LargePageSizeInBytes=128M  </span></span><br><span class="line"><span class="string">-XX:+UseFastAccessorMethods  </span></span><br><span class="line"><span class="string">-XX:+UseCMSInitiatingOccupancyOnly  </span></span><br><span class="line"><span class="string">-XX:CMSInitiatingOccupancyFraction=70 </span></span><br><span class="line"><span class="string">-XX:SoftRefLRUPolicyMSPerMB=0 </span></span><br><span class="line"><span class="string">-XX:+PrintClassHistogram  </span></span><br><span class="line"><span class="string">-XX:+PrintGCDetails  </span></span><br><span class="line"><span class="string">-XX:+PrintGCTimeStamps  </span></span><br><span class="line"><span class="string">-XX:+PrintHeapAtGC  </span></span><br><span class="line"><span class="string">-Xloggc:log/gc.log"</span>;</span><br></pre></td></tr></table></figure>

<p>64位jdk参考设置，年老代涨得很慢，CMS执行频率变小，CMS没有停滞，也不会有promotion failed问题，内存回收得很干净。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Huang Qingshan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://alifebug.github.io/2020/12/11/JVM%E8%B0%83%E4%BC%98/">http://alifebug.github.io/2020/12/11/JVM%E8%B0%83%E4%BC%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://ALifeBug.github.io">ALifeBug</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JVM/">JVM    </a></div><div class="post_share"><div class="social-share" data-image="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.png"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.png"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/11/Crontab/"><img class="prev_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Crontab</span></div></a></div><div class="next-post pull-right"><a href="/2020/12/11/Java%E7%9A%84%E5%A4%9A%E6%80%81%E6%80%A7/"><img class="next_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Java的多态性</span></div></a></div></nav></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2020 By Huang Qingshan</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>