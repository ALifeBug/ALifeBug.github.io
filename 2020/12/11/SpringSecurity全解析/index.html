<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>SpringSecurity全解析 | ALifeBug</title><meta name="description" content="SpringSecurity全解析"><meta name="keywords" content="SpringSecurity"><meta name="author" content="Huang Qingshan"><meta name="copyright" content="Huang Qingshan"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://alifebug.github.io/2020/12/11/SpringSecurity%E5%85%A8%E8%A7%A3%E6%9E%90/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SpringSecurity全解析"><meta name="twitter:description" content="SpringSecurity全解析"><meta name="twitter:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta property="og:type" content="article"><meta property="og:title" content="SpringSecurity全解析"><meta property="og:url" content="http://alifebug.github.io/2020/12/11/SpringSecurity%E5%85%A8%E8%A7%A3%E6%9E%90/"><meta property="og:site_name" content="ALifeBug"><meta property="og:description" content="SpringSecurity全解析"><meta property="og:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="PO、POJO、BO、VO、DTO、DAO区别与联系" href="http://alifebug.github.io/2020/12/11/PO%E3%80%81POJO%E3%80%81BO%E3%80%81VO%E3%80%81DTO%E3%80%81DAO%E5%8C%BA%E5%88%AB%E4%B8%8E%E8%81%94%E7%B3%BB/"><link rel="next" title="SpringSecurity整合JWT" href="http://alifebug.github.io/2020/12/11/SpringSecurity%E6%95%B4%E5%90%88JWT/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">ALifeBug</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">61</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">24</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#SpringSecurity全解析"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">SpringSecurity全解析</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Spring-Security"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">Spring Security</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#登录认证"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">登录认证</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#登录认证过滤器"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">登录认证过滤器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#退出登录"><span class="toc_mobile_items-number">1.2.2.</span> <span class="toc_mobile_items-text">退出登录</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#访问授权"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">访问授权</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#接口访问权限"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">接口访问权限</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#方法调用权限"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">方法调用权限</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#案例实现"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">案例实现</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#新建工程"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">新建工程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#添加依赖"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">添加依赖</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#启动类"><span class="toc_mobile_items-number">1.4.3.</span> <span class="toc_mobile_items-text">启动类</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#跨域配置类"><span class="toc_mobile_items-number">1.4.4.</span> <span class="toc_mobile_items-text">跨域配置类</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Swagger配置类"><span class="toc_mobile_items-number">1.4.5.</span> <span class="toc_mobile_items-text">Swagger配置类</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安全配置类"><span class="toc_mobile_items-number">1.4.6.</span> <span class="toc_mobile_items-text">安全配置类</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#登录认证触发过滤器"><span class="toc_mobile_items-number">1.4.7.</span> <span class="toc_mobile_items-text">登录认证触发过滤器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#登录控制器"><span class="toc_mobile_items-number">1.4.8.</span> <span class="toc_mobile_items-text">登录控制器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#令牌生成器"><span class="toc_mobile_items-number">1.4.9.</span> <span class="toc_mobile_items-text">令牌生成器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#登录身份认证组件"><span class="toc_mobile_items-number">1.4.10.</span> <span class="toc_mobile_items-text">登录身份认证组件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#认证信息获取服务"><span class="toc_mobile_items-number">1.4.11.</span> <span class="toc_mobile_items-text">认证信息获取服务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#用户认证信息"><span class="toc_mobile_items-number">1.4.12.</span> <span class="toc_mobile_items-text">用户认证信息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#用户操作代码"><span class="toc_mobile_items-number">1.4.13.</span> <span class="toc_mobile_items-text">用户操作代码</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#登录认证检查过滤器"><span class="toc_mobile_items-number">1.4.14.</span> <span class="toc_mobile_items-text">登录认证检查过滤器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#接口测试"><span class="toc_mobile_items-number">1.4.15.</span> <span class="toc_mobile_items-text">接口测试</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#源码下载"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">源码下载</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringSecurity全解析"><span class="toc-number">1.</span> <span class="toc-text">SpringSecurity全解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security"><span class="toc-number">1.1.</span> <span class="toc-text">Spring Security</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#登录认证"><span class="toc-number">1.2.</span> <span class="toc-text">登录认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#登录认证过滤器"><span class="toc-number">1.2.1.</span> <span class="toc-text">登录认证过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#退出登录"><span class="toc-number">1.2.2.</span> <span class="toc-text">退出登录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#访问授权"><span class="toc-number">1.3.</span> <span class="toc-text">访问授权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接口访问权限"><span class="toc-number">1.3.1.</span> <span class="toc-text">接口访问权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法调用权限"><span class="toc-number">1.3.2.</span> <span class="toc-text">方法调用权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例实现"><span class="toc-number">1.4.</span> <span class="toc-text">案例实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新建工程"><span class="toc-number">1.4.1.</span> <span class="toc-text">新建工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加依赖"><span class="toc-number">1.4.2.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动类"><span class="toc-number">1.4.3.</span> <span class="toc-text">启动类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#跨域配置类"><span class="toc-number">1.4.4.</span> <span class="toc-text">跨域配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Swagger配置类"><span class="toc-number">1.4.5.</span> <span class="toc-text">Swagger配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安全配置类"><span class="toc-number">1.4.6.</span> <span class="toc-text">安全配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录认证触发过滤器"><span class="toc-number">1.4.7.</span> <span class="toc-text">登录认证触发过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录控制器"><span class="toc-number">1.4.8.</span> <span class="toc-text">登录控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#令牌生成器"><span class="toc-number">1.4.9.</span> <span class="toc-text">令牌生成器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录身份认证组件"><span class="toc-number">1.4.10.</span> <span class="toc-text">登录身份认证组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#认证信息获取服务"><span class="toc-number">1.4.11.</span> <span class="toc-text">认证信息获取服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用户认证信息"><span class="toc-number">1.4.12.</span> <span class="toc-text">用户认证信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用户操作代码"><span class="toc-number">1.4.13.</span> <span class="toc-text">用户操作代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录认证检查过滤器"><span class="toc-number">1.4.14.</span> <span class="toc-text">登录认证检查过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接口测试"><span class="toc-number">1.4.15.</span> <span class="toc-text">接口测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码下载"><span class="toc-number">1.5.</span> <span class="toc-text">源码下载</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">SpringSecurity全解析</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-12-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-12-11</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/SpringSecurity/">SpringSecurity</a></span><div class="post-meta-wordcount"><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="SpringSecurity全解析"><a href="#SpringSecurity全解析" class="headerlink" title="SpringSecurity全解析"></a>SpringSecurity全解析</h1><h2 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h2><p>Spring Security 是 Spring 社区的一个顶级项目，也是 Spring Boot 官方推荐使用的安全框架。除了常规的认证（Authentication）和授权（Authorization）之外，Spring Security还提供了诸如ACLs，LDAP，JAAS，CAS等高级特性以满足复杂场景下的安全需求。</p>
<p>Spring Security 应用级别的安全主要包含两个主要部分，即登录认证（Authentication）和访问授权（Authorization），首先用户登录的时候传入登录信息，登录验证器完成登录认证并将登录认证好的信息存储到请求上下文，然后在进行其他操作，如接口访问、方法调用时，权限认证器从上下文中获取登录认证信息，然后根据认证信息获取权限信息，通过权限信息和特定的授权策略决定是否授权。</p>
<p>接下来，本教程将分别对登录认证和访问授权的执行流程进行剖析，并在最后给出完整的案例实现，如果觉得先读前面原理比较难懂，可以先学习后面的实现案例，再结合案例理解登录认证和访问授权的执行原理。</p>
<h2 id="登录认证"><a href="#登录认证" class="headerlink" title="登录认证"></a>登录认证</h2><h3 id="登录认证过滤器"><a href="#登录认证过滤器" class="headerlink" title="登录认证过滤器"></a>登录认证过滤器</h3><p>如果在继承 WebSecurityConfigurerAdapter 的配置类中的 configure(HttpSecurity http) 方法中有配置 HttpSecurity 的 formLogin，则会返回一个 FormLoginConfigurer 对象。如下是一个 Spring Security 的配置样例， formLogin().x.x 就是配置使用内置的登录验证过滤器，默认实现为 UsernamePasswordAuthenticationFilter。</p>
<p>WebSecurityConfig.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 使用自定义身份验证组件</span></span><br><span class="line">        auth.authenticationProvider(<span class="keyword">new</span> JwtAuthenticationProvider(userDetailsService));</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        http.cors().and().csrf().disable()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">        <span class="comment">// 首页和登录页面</span></span><br><span class="line">        .antMatchers(<span class="string">"/"</span>).permitAll()</span><br><span class="line">        <span class="comment">// 其他所有请求需要身份认证</span></span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">        <span class="comment">// 配置登录认证</span></span><br><span class="line">        .and().formLogin().loginProcessingUrl(<span class="string">"/login"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查看 HttpSecurity , formLogion 方法返回一个 FormLoginConfigurer 对象。</p>
<p>HttpSecurity.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FormLoginConfigurer<HttpSecurity> <span class="title">formLogin</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">return</span> getOrApply(<span class="keyword">new</span> FormLoginConfigurer<>());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>而 FormLoginConfigurer 的构造函数内绑定了一个 UsernamePasswordAuthenticationFilter 过滤器。</p>
<p>FormLoginConfigurer.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FormLoginConfigurer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(<span class="keyword">new</span> UsernamePasswordAuthenticationFilter(), <span class="keyword">null</span>);</span><br><span class="line">    usernameParameter(<span class="string">"username"</span>);</span><br><span class="line">    passwordParameter(<span class="string">"password"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>再看 UsernamePasswordAuthenticationFilter 过滤器的构造函数内绑定了 POST 类型的 /login 请求，也就是说，如果配置了 formLogin 的相关信息，那么在使用 POST 类型的 /login URL进行登录的时候就会被这个过滤器拦截，并进行登录验证，登录验证过程我们下面继续分析。</p>
<p>UsernamePasswordAuthenticationFilter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UsernamePasswordAuthenticationFilter</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(<span class="string">"/login"</span>, <span class="string">"POST"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>查看 UsernamePasswordAuthenticationFilter，发现它继承了 AbstractAuthenticationProcessingFilter，AbstractAuthenticationProcessingFilter 中的 doFilter 包含了触发登录认证执行流程的相关逻辑。</p>
<p>AbstractAuthenticationProcessingFilter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        Authentication authResult;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            authResult = attemptAuthentication(request, response);</span><br><span class="line">            <span class="keyword">if</span> (authResult == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// return immediately as subclass has indicated that it hasn't completed</span></span><br><span class="line">                <span class="comment">// authentication</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            sessionStrategy.onAuthentication(authResult, request, response);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">　　　　　...</span><br><span class="line"></span><br><span class="line">        successfulAuthentication(request, response, chain, authResult);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>上面的登录逻辑主要步骤有两个：</p>
<p>\1. attemptAuthentication(request, response)</p>
<p>这是 AbstractAuthenticationProcessingFilter  中的一个抽象方法，包含登录主逻辑，由其子类实现具体的登录验证，如 UsernamePasswordAuthenticationFilter 是使用表单方式登录的具体实现。如果是非表单登录的方式，如JNDI等其他方式登录的可以通过继承 AbstractAuthenticationProcessingFilter 自定义登录实现。UsernamePasswordAuthenticationFilter 的登录实现逻辑如下。</p>
<p>UsernamePasswordAuthenticationFilter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        <span class="keyword">if</span> (postOnly && !request.getMethod().equals(<span class="string">"POST"</span>)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">"Authentication method not supported: "</span> + request.getMethod());</span><br><span class="line">        }</span><br><span class="line">　　　　　<span class="comment">// 获取用户名和密码</span></span><br><span class="line">        String username = obtainUsername(request);</span><br><span class="line">        String password = obtainPassword(request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (username == <span class="keyword">null</span>) {</span><br><span class="line">            username = <span class="string">""</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (password == <span class="keyword">null</span>) {</span><br><span class="line">            password = <span class="string">""</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        username = username.trim();</span><br><span class="line"></span><br><span class="line">        UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username, password);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow subclasses to set the "details" property</span></span><br><span class="line">        setDetails(request, authRequest);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>\2. successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult)</p>
<p>登录成功之后，将认证后的 Authentication 对象存储到请求线程上下文，这样在授权阶段就可以获取到 Authentication 认证信息，并利用 Authentication 内的权限信息进行访问控制判断。</p>
<p>AbstractAuthenticationProcessingFilter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">successfulAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">        HttpServletResponse response, FilterChain chain, Authentication authResult)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">        logger.debug(<span class="string">"Authentication success. Updating SecurityContextHolder to contain: "</span> + authResult);</span><br><span class="line">    }</span><br><span class="line">　　　　　<span class="comment">// 登录成功之后，把认证后的 Authentication 对象存储到请求线程上下文，这样在授权阶段就可以获取到此认证信息进行访问控制判断</span></span><br><span class="line">    SecurityContextHolder.getContext().setAuthentication(authResult);</span><br><span class="line"></span><br><span class="line">    rememberMeServices.loginSuccess(request, response, authResult);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fire event</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.eventPublisher != <span class="keyword">null</span>) {</span><br><span class="line">        eventPublisher.publishEvent(<span class="keyword">new</span> InteractiveAuthenticationSuccessEvent(</span><br><span class="line">                authResult, <span class="keyword">this</span>.getClass()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    successHandler.onAuthenticationSuccess(request, response, authResult);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>从上面的登录逻辑我们可以看到，Spring Security的登录认证过程是委托给 AuthenticationManager 完成的，它先是解析出用户名和密码，然后把用户名和密码封装到一个UsernamePasswordAuthenticationToken 中，传递给 AuthenticationManager，交由 AuthenticationManager 完成实际的登录认证过程。 </p>
<p>AuthenticationManager.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.authentication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">\* Processes an {<span class="doctag">@link</span> Authentication} request.</span></span><br><span class="line"><span class="comment">\* <span class="doctag">@author</span> Ben Alex</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationManager</span> </span>{</span><br><span class="line"></span><br><span class="line">　　<span class="function">Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>AuthenticationManager 提供了一个默认的 实现 ProviderManager，而 ProviderManager 又将验证委托给了 AuthenticationProvider。</p>
<p>ProviderManager.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">　　　　　...</span><br><span class="line">　　 <span class="keyword">for</span> (AuthenticationProvider provider : getProviders()) {</span><br><span class="line">        <span class="keyword">if</span> (!provider.supports(toTest)) {</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }<span class="keyword">try</span> {</span><br><span class="line">            result = provider.authenticate(authentication);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="keyword">null</span>) {</span><br><span class="line">                copyDetails(authentication, result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">　　　　 ...</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>根据验证方式的多样化，AuthenticationProvider 衍生出多种类型的实现，AbstractUserDetailsAuthenticationProvider 是 AuthenticationProvider 的抽象实现，定义了较为统一的验证逻辑，各种验证方式可以选择直接继承 AbstractUserDetailsAuthenticationProvider 完成登录认证，如 DaoAuthenticationProvider 就是继承了此抽象类，完成了从DAO方式获取验证需要的用户信息的。</p>
<p>AbstractUserDetailsAuthenticationProvider.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>{<span class="comment">// Determine username</span></span><br><span class="line">        String username = (authentication.getPrincipal() == <span class="keyword">null</span>) ? <span class="string">"NONE_PROVIDED"</span> : authentication.getName();</span><br><span class="line">        <span class="keyword">boolean</span> cacheWasUsed = <span class="keyword">true</span>;</span><br><span class="line">        UserDetails user = <span class="keyword">this</span>.userCache.getUserFromCache(username);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) {</span><br><span class="line">            cacheWasUsed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">　　　　　　　　　 <span class="comment">// 子类根据自身情况从指定的地方加载认证需要的用户信息</span></span><br><span class="line">                user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">            }</span><br><span class="line">            ...<span class="keyword">try</span> {</span><br><span class="line">　　　　　　　<span class="comment">// 前置检查，一般是检查账号状态，如是否锁定之类</span></span><br><span class="line">            preAuthenticationChecks.check(user);</span><br><span class="line"></span><br><span class="line">　　　　　　　<span class="comment">// 进行一般逻辑认证，如 DaoAuthenticationProvider 实现中的密码验证就是在这里完成的</span></span><br><span class="line">            additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">        }</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">　　　　 <span class="comment">//　后置检查，如可以检查密码是否过期之类</span></span><br><span class="line">        postAuthenticationChecks.check(user);</span><br><span class="line"></span><br><span class="line">　　　　 ...</span><br><span class="line">　　　　　<span class="comment">// 验证成功之后返回包含完整认证信息的 Authentication 对象</span></span><br><span class="line">        <span class="keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>如上面所述， AuthenticationProvider 通过 retrieveUser(String username, UsernamePasswordAuthenticationToken authentication) 获取验证信息，对于我们一般所用的 DaoAuthenticationProvider 是由 UserDetailsService 专门负责获取验证信息的。</p>
<p>DaoAuthenticationProvider.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> UserDetails <span class="title">retrieveUser</span><span class="params">(String username, UsernamePasswordAuthenticationToken authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        UserDetails loadedUser = <span class="keyword">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (loadedUser == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(<span class="string">"UserDetailsService returned null, which is an interface contract violation"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> loadedUser;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>UserDetailsService 接口只有一个方法，loadUserByUsername(String username)，一般需要我们实现此接口方法，根据用户名加载登录认证和访问授权所需要的信息，并返回一个 UserDetails的实现类，后面登录认证和访问授权都需要用到此中的信息。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsService</span> </span>{</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Locates the user based on the username. In the actual implementation, the search</span></span><br><span class="line"><span class="comment">     * may possibly be case sensitive, or case insensitive depending on how the</span></span><br><span class="line"><span class="comment">     * implementation instance is configured. In this case, the <code>UserDetails</code></span></span><br><span class="line"><span class="comment">     * object that comes back may have a username that is of a different case than what</span></span><br><span class="line"><span class="comment">     * was actually requested..</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username the username identifying the user whose data is required.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a fully populated user record (never <code>null</code>)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException if the user could not be found or the user has no</span></span><br><span class="line"><span class="comment">     * GrantedAuthority</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>UserDetails 提供了一个默认实现 User，主要包含用户名（username）、密码(password)、权限（authorities）和一些账号或密码状态的标识。</p>
<p>如果默认实现满足不了你的需求，可以根据需求定制自己的 UserDetails，然后在 UserDetailsService 的 loadUserByUsername 中返回即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">UserDetails</span>, <span class="title">CredentialsContainer</span> </span>{<span class="comment">// ~ Instance fields</span></span><br><span class="line">    <span class="comment">// ================================================================================================</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set<GrantedAuthority> authorities;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> accountNonExpired;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> accountNonLocked;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> credentialsNonExpired;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> enabled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ~ Constructors</span></span><br><span class="line">    <span class="comment">// ===================================================================================================</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String username, String password,</span></span></span><br><span class="line"><span class="function"><span class="params">            Collection<? extends GrantedAuthority> authorities)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(username, password, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, authorities);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">　　 ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h3><p>Spring Security 提供了一个默认的登出过滤器 LogoutFilter，默认拦截路径是 /logout，当访问 /logout 路径的时候，LogoutFilter 会进行退出处理。</p>
<p>LogoutFilter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.web.authentication.logout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogoutFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ~ Instance fields</span></span><br><span class="line">    <span class="comment">// ================================================================================================</span></span><br><span class="line">    <span class="keyword">private</span> RequestMatcher logoutRequestMatcher;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LogoutHandler handler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LogoutSuccessHandler logoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ~ Constructors</span></span><br><span class="line">    <span class="comment">// ===================================================================================================</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogoutFilter</span><span class="params">(LogoutSuccessHandler logoutSuccessHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">            LogoutHandler... handlers)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.handler = <span class="keyword">new</span> CompositeLogoutHandler(handlers);</span><br><span class="line">        Assert.notNull(logoutSuccessHandler, <span class="string">"logoutSuccessHandler cannot be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.logoutSuccessHandler = logoutSuccessHandler;</span><br><span class="line">        setFilterProcessesUrl(<span class="string">"/logout"</span>);　　<span class="comment">// 绑定 /logout</span></span><br><span class="line">    }<span class="comment">// ~ Methods</span></span><br><span class="line">    <span class="comment">// ========================================================================================================</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) req;</span><br><span class="line">        HttpServletResponse response = (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requiresLogout(request, response)) {</span><br><span class="line">            Authentication auth = SecurityContextHolder.getContext().getAuthentication();<span class="keyword">this</span>.handler.logout(request, response, auth);　　<span class="comment">// 登出处理，可能包含session、cookie、认证信息的清理工作</span></span><br><span class="line"></span><br><span class="line">            logoutSuccessHandler.onLogoutSuccess(request, response, auth);　　<span class="comment">// 退出后的操作，可能是跳转、返回成功状态等</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如下是 SecurityContextLogoutHandler 中的登出处理实现。</p>
<p>SecurityContextLogoutHandler.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">        Authentication authentication)</span> </span>{</span><br><span class="line">    <span class="comment">// 让 session 失效　if (invalidateHttpSession) {</span></span><br><span class="line">        HttpSession session = request.getSession(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span>) {</span><br><span class="line">            logger.debug(<span class="string">"Invalidating session: "</span> + session.getId());</span><br><span class="line">            session.invalidate();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">　　　　　<span class="comment">// 清理 Security 上下文，其中包含登录认证信息</span></span><br><span class="line">    <span class="keyword">if</span> (clearAuthentication) {</span><br><span class="line">        SecurityContext context = SecurityContextHolder.getContext();</span><br><span class="line">        context.setAuthentication(<span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line">    SecurityContextHolder.clearContext();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="访问授权"><a href="#访问授权" class="headerlink" title="访问授权"></a>访问授权</h2><p>访问授权主要分为两种：通过URL方式的接口访问控制和方法调用的权限控制。</p>
<h3 id="接口访问权限"><a href="#接口访问权限" class="headerlink" title="接口访问权限"></a>接口访问权限</h3><p>在通过比如浏览器使用URL访问后台接口时，是否允许访问此URL，就是接口访问权限。</p>
<p>在进行接口访问时，会由 FilterSecurityInterceptor 进行拦截并进行授权。</p>
<p>FilterSecurityInterceptor 继承了 AbstractSecurityInterceptor 并实现了 javax.servlet.Filter 接口， 所以在URL访问的时候都会被过滤器拦截，doFilter 实现如下。</p>
<p>FilterSecurityInterceptor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">        FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">    FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(request, response, chain);</span><br><span class="line">    invoke(fi);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>doFilter 方法又调用了自身的 invoke 方法， invoke 方法又调用了父类 AbstractSecurityInterceptor 的 beforeInvocation 方法。</p>
<p>FilterSecurityInterceptor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">    <span class="keyword">if</span> ((fi.getRequest() != <span class="keyword">null</span>)</span><br><span class="line">            && (fi.getRequest().getAttribute(FILTER_APPLIED) != <span class="keyword">null</span>)</span><br><span class="line">            && observeOncePerRequest) {</span><br><span class="line">        <span class="comment">// filter already applied to this request and user wants us to observe</span></span><br><span class="line">        <span class="comment">// once-per-request handling, so don't re-do security checking</span></span><br><span class="line">        fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// first time this request being called, so perform security checking</span></span><br><span class="line">        <span class="keyword">if</span> (fi.getRequest() != <span class="keyword">null</span> && observeOncePerRequest) {</span><br><span class="line">            fi.getRequest().setAttribute(FILTER_APPLIED, Boolean.TRUE);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">super</span>.finallyInvocation(token);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="方法调用权限"><a href="#方法调用权限" class="headerlink" title="方法调用权限"></a>方法调用权限</h3><p>在进行后台方法调用时，是否允许该方法调用，就是方法调用权限。比如在方法上添加了此类注解 @PreAuthorize(“hasRole(‘ROLE_ADMIN’)”) ，Security 方法注解的支持需要在任何配置类中（如 WebSecurityConfigurerAdapter ）添加 @EnableGlobalMethodSecurity(prePostEnabled = true) 开启，才能够使用。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在进行方法调用时，会由 MethodSecurityInterceptor 进行拦截并进行授权。</p>
<p>MethodSecurityInterceptor 继承了 AbstractSecurityInterceptor 并实现了AOP 的 org.aopalliance.intercept.MethodInterceptor 接口， 所以可以在方法调用时进行拦截。</p>
<p>MethodSecurityInterceptor .java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">    InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(mi);</span><br><span class="line"></span><br><span class="line">    Object result;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        result = mi.proceed();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">super</span>.finallyInvocation(token);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.afterInvocation(token, result);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们看到，MethodSecurityInterceptor 跟 FilterSecurityInterceptor 一样， 都是通过调用父类 AbstractSecurityInterceptor 的相关方法完成授权，其中 beforeInvocation 是完成权限认证的关键。</p>
<p>AbstractSecurityInterceptor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> InterceptorStatusToken <span class="title">beforeInvocation</span><span class="params">(Object object)</span> </span>{</span><br><span class="line">        ...</span><br><span class="line">　　　　　<span class="comment">// 通过 SecurityMetadataSource 获取权限配置信息，可以定制实现自己的权限信息获取逻辑</span></span><br><span class="line">        Collection<ConfigAttribute> attributes = <span class="keyword">this</span>.obtainSecurityMetadataSource().getAttributes(object);</span><br><span class="line"></span><br><span class="line">　　　　　...</span><br><span class="line"></span><br><span class="line">　　　　　<span class="comment">// 确认是否经过登录认证　　　　　</span></span><br><span class="line">        Authentication authenticated = authenticateIfRequired();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Attempt authorization</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">　　　　　　  <span class="comment">// 通过 AccessDecisionManager 完成授权认证，默认实现是 AffirmativeBased</span></span><br><span class="line">            <span class="keyword">this</span>.accessDecisionManager.decide(authenticated, object, attributes);</span><br><span class="line">        }</span><br><span class="line">        ...</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>上面代码显示 AbstractSecurityInterceptor 又是委托授权认证器 AccessDecisionManager 完成授权认证，默认实现是 AffirmativeBased， decide 方法实现如下。</p>
<p>AffirmativeBased.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object object,</span></span></span><br><span class="line"><span class="function"><span class="params">            Collection<ConfigAttribute> configAttributes)</span> <span class="keyword">throws</span> AccessDeniedException </span>{</span><br><span class="line">        <span class="keyword">int</span> deny = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (AccessDecisionVoter voter : getDecisionVoters()) {</span><br><span class="line">　　</span><br><span class="line">　　　　　　　 <span class="comment">// 通过各种投票策略，最终决定是否授权　</span></span><br><span class="line">            <span class="keyword">int</span> result = voter.vote(authentication, object, configAttributes);</span><br><span class="line"><span class="keyword">switch</span> (result) {</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> AccessDecisionVoter.ACCESS_GRANTED:</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> AccessDecisionVoter.ACCESS_DENIED:</span><br><span class="line">                deny++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">　　　　...</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>而 AccessDecisionManager 决定授权又是通过一个授权策略集合（AccessDecisionVoter ）决定的，授权决定的原则是：</p>
<p>  \1. 遍历所有授权策略， 如果有其中一个返回 ACCESS_GRANTED，则同意授权。</p>
<p>  \2. 否则，等待遍历结束，统计 ACCESS_DENIED 个数，只要拒绝数大于1，则不同意授权。</p>
<p>对于接口访问授权，也就是 FilterSecurityInterceptor 管理的URL授权，默认对应的授权策略只有一个，就是 WebExpressionVoter，它的授权策略主要是根据 WebSecurityConfigurerAdapter 内配置的路径访问策略进行匹配，然后决定是否授权。</p>
<p>WebExpressionVoter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Voter which handles web authorisation decisions.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Luke Taylor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebExpressionVoter</span> <span class="keyword">implements</span> <span class="title">AccessDecisionVoter</span><<span class="title">FilterInvocation</span>> </span>{</span><br><span class="line">    <span class="keyword">private</span> SecurityExpressionHandler<FilterInvocation> expressionHandler = <span class="keyword">new</span> DefaultWebSecurityExpressionHandler();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">vote</span><span class="params">(Authentication authentication, FilterInvocation fi,</span></span></span><br><span class="line"><span class="function"><span class="params">            Collection<ConfigAttribute> attributes)</span> </span>{</span><br><span class="line">        <span class="keyword">assert</span> authentication != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">assert</span> fi != <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">assert</span> attributes != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        WebExpressionConfigAttribute weca = findConfigAttribute(attributes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (weca == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> ACCESS_ABSTAIN;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        EvaluationContext ctx = expressionHandler.createEvaluationContext(authentication, fi);</span><br><span class="line"></span><br><span class="line">        ctx = weca.postProcess(ctx, fi);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ExpressionUtils.evaluateAsBoolean(weca.getAuthorizeExpression(), ctx) ? ACCESS_GRANTED : ACCESS_DENIED;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>对于方法调用授权，在全局方法安全配置类里，可以看到给 MethodSecurityInterceptor 默认配置的有 RoleVoter、AuthenticatedVoter、Jsr250Voter、和 PreInvocationAuthorizationAdviceVoter，其中 Jsr250Voter、PreInvocationAuthorizationAdviceVoter 都需要打开指定的开关，才会添加支持。</p>
<p>GlobalMethodSecurityConfiguration.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalMethodSecurityConfiguration</span> <span class="keyword">implements</span> <span class="title">ImportAware</span>, <span class="title">SmartInitializingSingleton</span> </span>{</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span> MethodSecurityInterceptor methodSecurityInterceptor;</span><br><span class="line">        </span><br><span class="line">　　<span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodInterceptor <span class="title">methodSecurityInterceptor</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">this</span>.methodSecurityInterceptor = isAspectJ()</span><br><span class="line">                ? <span class="keyword">new</span> AspectJMethodSecurityInterceptor()</span><br><span class="line">                : <span class="keyword">new</span> MethodSecurityInterceptor();</span><br><span class="line">        methodSecurityInterceptor.setAccessDecisionManager(accessDecisionManager());</span><br><span class="line">        methodSecurityInterceptor.setAfterInvocationManager(afterInvocationManager());</span><br><span class="line">        methodSecurityInterceptor</span><br><span class="line">                .setSecurityMetadataSource(methodSecurityMetadataSource());</span><br><span class="line">        RunAsManager runAsManager = runAsManager();</span><br><span class="line">        <span class="keyword">if</span> (runAsManager != <span class="keyword">null</span>) {</span><br><span class="line">            methodSecurityInterceptor.setRunAsManager(runAsManager);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.methodSecurityInterceptor;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AccessDecisionManager <span class="title">accessDecisionManager</span><span class="params">()</span> </span>{</span><br><span class="line">        List<AccessDecisionVoter<? extends Object>> decisionVoters = <span class="keyword">new</span> ArrayList<AccessDecisionVoter<? extends Object>>();</span><br><span class="line">        ExpressionBasedPreInvocationAdvice expressionAdvice = <span class="keyword">new</span> ExpressionBasedPreInvocationAdvice();</span><br><span class="line">        expressionAdvice.setExpressionHandler(getExpressionHandler());</span><br><span class="line">        <span class="keyword">if</span> (prePostEnabled()) {</span><br><span class="line">            decisionVoters</span><br><span class="line">                    .add(<span class="keyword">new</span> PreInvocationAuthorizationAdviceVoter(expressionAdvice));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (jsr250Enabled()) {</span><br><span class="line">            decisionVoters.add(<span class="keyword">new</span> Jsr250Voter());</span><br><span class="line">        }</span><br><span class="line">        decisionVoters.add(<span class="keyword">new</span> RoleVoter());</span><br><span class="line">        decisionVoters.add(<span class="keyword">new</span> AuthenticatedVoter());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AffirmativeBased(decisionVoters);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">　　...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>RoleVoter 是根据角色进行匹配授权的策略。</p>
<p>RoleVoter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleVoter</span> <span class="keyword">implements</span> <span class="title">AccessDecisionVoter</span><<span class="title">Object</span>> </span>{</span><br><span class="line"></span><br><span class="line">　　 <span class="comment">// RoleVoter  默认角色名以 "ROLE_" 为前缀。</span></span><br><span class="line">    <span class="keyword">private</span> String rolePrefix = <span class="string">"ROLE_"</span>;<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute attribute)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> ((attribute.getAttribute() != <span class="keyword">null</span>)</span><br><span class="line">                && attribute.getAttribute().startsWith(getRolePrefix())) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">vote</span><span class="params">(Authentication authentication, Object object,</span></span></span><br><span class="line"><span class="function"><span class="params">            Collection<ConfigAttribute> attributes)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span>(authentication == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> ACCESS_DENIED;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">int</span> result = ACCESS_ABSTAIN;</span><br><span class="line">        Collection<? extends GrantedAuthority> authorities = extractAuthorities(authentication);</span><br><span class="line">　　　　　<span class="comment">// 逐个角色进行匹配，入股有一个匹配得上，则进行授权</span></span><br><span class="line">        <span class="keyword">for</span> (ConfigAttribute attribute : attributes) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.supports(attribute)) {</span><br><span class="line">                result = ACCESS_DENIED;</span><br><span class="line">                <span class="comment">// Attempt to find a matching granted authority</span></span><br><span class="line">                <span class="keyword">for</span> (GrantedAuthority authority : authorities) {</span><br><span class="line">                    <span class="keyword">if</span> (attribute.getAttribute().equals(authority.getAuthority())) {</span><br><span class="line">                        <span class="keyword">return</span> ACCESS_GRANTED;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Collection<? extends GrantedAuthority> extractAuthorities(Authentication authentication) {</span><br><span class="line">        <span class="keyword">return</span> authentication.getAuthorities();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>AuthenticatedVoter 主要是针对有配置以下几个属性来决定授权的策略。</p>
<p>IS_AUTHENTICATED_REMEMBERED：记住我登录状态</p>
<p>IS_AUTHENTICATED_ANONYMOUSLY：匿名认证状态</p>
<p>IS_AUTHENTICATED_FULLY： 完全登录状态，即非上面两种类型</p>
<p>AuthenticatedVoter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">vote</span><span class="params">(Authentication authentication, Object object,</span></span></span><br><span class="line"><span class="function"><span class="params">            Collection<ConfigAttribute> attributes)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> result = ACCESS_ABSTAIN;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ConfigAttribute attribute : attributes) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.supports(attribute)) {</span><br><span class="line">                result = ACCESS_DENIED;</span><br><span class="line">　　　　　　　　　　<span class="comment">// 完全登录状态</span></span><br><span class="line">                <span class="keyword">if</span> (IS_AUTHENTICATED_FULLY.equals(attribute.getAttribute())) {</span><br><span class="line">                    <span class="keyword">if</span> (isFullyAuthenticated(authentication)) {</span><br><span class="line">                        <span class="keyword">return</span> ACCESS_GRANTED;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">　　　　　　　　　 <span class="comment">// 记住我登录状态</span></span><br><span class="line">                <span class="keyword">if</span> (IS_AUTHENTICATED_REMEMBERED.equals(attribute.getAttribute())) {</span><br><span class="line">                    <span class="keyword">if</span> (authenticationTrustResolver.isRememberMe(authentication)</span><br><span class="line">                            || isFullyAuthenticated(authentication)) {</span><br><span class="line">                        <span class="keyword">return</span> ACCESS_GRANTED;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">　　　　　　　　　 <span class="comment">// 匿名登录状态</span></span><br><span class="line">                <span class="keyword">if</span> (IS_AUTHENTICATED_ANONYMOUSLY.equals(attribute.getAttribute())) {</span><br><span class="line">                    <span class="keyword">if</span> (authenticationTrustResolver.isAnonymous(authentication)</span><br><span class="line">                            || isFullyAuthenticated(authentication)</span><br><span class="line">                            || authenticationTrustResolver.isRememberMe(authentication)) {</span><br><span class="line">                        <span class="keyword">return</span> ACCESS_GRANTED;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>PreInvocationAuthorizationAdviceVoter 是针对类似  @PreAuthorize(“hasRole(‘ROLE_ADMIN’)”)  注解解析并进行授权的策略。</p>
<p>PreInvocationAuthorizationAdviceVoter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PreInvocationAuthorizationAdviceVoter</span> <span class="keyword">implements</span> <span class="title">AccessDecisionVoter</span><<span class="title">MethodInvocation</span>> </span>{<span class="keyword">private</span> <span class="keyword">final</span> PreInvocationAuthorizationAdvice preAdvice;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">vote</span><span class="params">(Authentication authentication, MethodInvocation method,</span></span></span><br><span class="line"><span class="function"><span class="params">            Collection<ConfigAttribute> attributes)</span> </span>{</span><br><span class="line"></span><br><span class="line">        PreInvocationAttribute preAttr = findPreInvocationAttribute(attributes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preAttr == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// No expression based metadata, so abstain</span></span><br><span class="line">            <span class="keyword">return</span> ACCESS_ABSTAIN;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> allowed = preAdvice.before(authentication, method, preAttr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> allowed ? ACCESS_GRANTED : ACCESS_DENIED;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PreInvocationAttribute <span class="title">findPreInvocationAttribute</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Collection<ConfigAttribute> config)</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (ConfigAttribute attribute : config) {</span><br><span class="line">            <span class="keyword">if</span> (attribute <span class="keyword">instanceof</span> PreInvocationAttribute) {</span><br><span class="line">                <span class="keyword">return</span> (PreInvocationAttribute) attribute;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>PreInvocationAuthorizationAdviceVoter 解析出注解属性配置， 然后通过调用 PreInvocationAuthorizationAdvice 的前置通知方法进行授权认证，默认实现类似 ExpressionBasedPreInvocationAdvice，通知内主要进行了内容的过滤和权限表达式的匹配。</p>
<p>ExpressionBasedPreInvocationAdvice.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExpressionBasedPreInvocationAdvice</span> <span class="keyword">implements</span> <span class="title">PreInvocationAuthorizationAdvice</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> MethodSecurityExpressionHandler expressionHandler = <span class="keyword">new</span> DefaultMethodSecurityExpressionHandler();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">before</span><span class="params">(Authentication authentication, MethodInvocation mi, PreInvocationAttribute attr)</span> </span>{</span><br><span class="line">        PreInvocationExpressionAttribute preAttr = (PreInvocationExpressionAttribute) attr;</span><br><span class="line">        EvaluationContext ctx = expressionHandler.createEvaluationContext(authentication, mi);</span><br><span class="line">        Expression preFilter = preAttr.getFilterExpression();</span><br><span class="line">        Expression preAuthorize = preAttr.getAuthorizeExpression();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preFilter != <span class="keyword">null</span>) {</span><br><span class="line">            Object filterTarget = findFilterTarget(preAttr.getFilterTarget(), ctx, mi);</span><br><span class="line">            expressionHandler.filter(filterTarget, preFilter, ctx);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preAuthorize == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ExpressionUtils.evaluateAsBoolean(preAuthorize, ctx);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">　　...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="案例实现"><a href="#案例实现" class="headerlink" title="案例实现"></a>案例实现</h2><p>接下来，我们以一个实现案例来进行说明讲解。</p>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><p>新建一个 Spring Boot 项目 springboot-spring-security。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128154034209-1921752671.png" class="lozad"></p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>添加项目依赖，主要是 Spring Security 和 JWT，另外添加 Swagger 和 fastjson 作为辅助工具。</p>
<p>pom.xml</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?></span><br><span class="line"><project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>></span><br><span class="line">    <modelVersion>4.0.0</modelVersion></span><br><span class="line"></span><br><span class="line">    <groupId>top.ivan.demo</groupId></span><br><span class="line">    <artifactId>springboot-spring-security</artifactId></span><br><span class="line">    <version>0.0.1-SNAPSHOT</version></span><br><span class="line">    <packaging>jar</packaging></span><br><span class="line"></span><br><span class="line">    <name>springboot-spring-security</name></span><br><span class="line">    <description>Demo project for Spring Boot</description></span><br><span class="line"></span><br><span class="line">    <parent></span><br><span class="line">        <groupId>org.springframework.boot</groupId></span><br><span class="line">        <artifactId>spring-boot-starter-parent</artifactId></span><br><span class="line">        <version>2.0.4.RELEASE</version></span><br><span class="line">        <relativePath/> <!-- lookup parent from repository --></span><br><span class="line">    </parent></span><br><span class="line"></span><br><span class="line">    <properties></span><br><span class="line">        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding></span><br><span class="line">        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding></span><br><span class="line">        <java.version>1.8</java.version></span><br><span class="line">        <mybatis.spring.version>1.3.2</mybatis.spring.version></span><br><span class="line">        <swagger.version>2.8.0</swagger.version></span><br><span class="line">        <jwt.version>0.9.1</jwt.version></span><br><span class="line">        <fastjson.version>1.2.48</fastjson.version></span><br><span class="line">    </properties></span><br><span class="line"></span><br><span class="line">    <dependencies></span><br><span class="line">           <!-- spring boot --></span><br><span class="line">        <dependency></span><br><span class="line">            <groupId>org.springframework.boot</groupId></span><br><span class="line">            <artifactId>spring-boot-starter-web</artifactId></span><br><span class="line">        </dependency></span><br><span class="line">        <dependency></span><br><span class="line">            <groupId>org.springframework.boot</groupId></span><br><span class="line">            <artifactId>spring-boot-starter-test</artifactId></span><br><span class="line">            <scope>test</scope></span><br><span class="line">        </dependency></span><br><span class="line">        <!-- swagger --></span><br><span class="line">        <dependency></span><br><span class="line">            <groupId>io.springfox</groupId></span><br><span class="line">            <artifactId>springfox-swagger2</artifactId></span><br><span class="line">            <version>${swagger.version}</version></span><br><span class="line">        </dependency></span><br><span class="line">        <dependency></span><br><span class="line">            <groupId>io.springfox</groupId></span><br><span class="line">            <artifactId>springfox-swagger-ui</artifactId></span><br><span class="line">            <version>${swagger.version}</version></span><br><span class="line">        </dependency></span><br><span class="line">        <!-- spring security --></span><br><span class="line">        <dependency></span><br><span class="line">            <groupId>org.springframework.boot</groupId></span><br><span class="line">            <artifactId>spring-boot-starter-security</artifactId></span><br><span class="line">        </dependency></span><br><span class="line">        <!-- jwt --></span><br><span class="line">        <dependency></span><br><span class="line">            <groupId>io.jsonwebtoken</groupId></span><br><span class="line">            <artifactId>jjwt</artifactId></span><br><span class="line">            <version>${jwt.version}</version></span><br><span class="line">        </dependency></span><br><span class="line">        <!-- fastjson --></span><br><span class="line">        <dependency></span><br><span class="line">            <groupId>com.alibaba</groupId></span><br><span class="line">            <artifactId>fastjson</artifactId></span><br><span class="line">            <version>${fastjson.version}</version></span><br><span class="line">        </dependency></span><br><span class="line">    </dependencies></span><br><span class="line"></span><br><span class="line">    <build></span><br><span class="line">        <plugins></span><br><span class="line">            <plugin></span><br><span class="line">                <groupId>org.springframework.boot</groupId></span><br><span class="line">                <artifactId>spring-boot-maven-plugin</artifactId></span><br><span class="line">            </plugin></span><br><span class="line">        </plugins></span><br><span class="line">    </build></span><br><span class="line"></span><br><span class="line"></project></span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h3><p>启动类没什么，主要开启以下包扫描。</p>
<p>SpringSecurityApplication.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.louis.springboot"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringSecurityApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(SpringSecurityApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="跨域配置类"><a href="#跨域配置类" class="headerlink" title="跨域配置类"></a>跨域配置类</h3><p>跨域配置类，不多说，都懂得。</p>
<p>CorsConfig.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跨域配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>{</span><br><span class="line">        registry.addMapping(<span class="string">"/**"</span>)    <span class="comment">// 允许跨域访问的路径</span></span><br><span class="line">        .allowedOrigins(<span class="string">"*"</span>)    <span class="comment">// 允许跨域访问的源</span></span><br><span class="line">        .allowedMethods(<span class="string">"POST"</span>, <span class="string">"GET"</span>, <span class="string">"PUT"</span>, <span class="string">"OPTIONS"</span>, <span class="string">"DELETE"</span>)    <span class="comment">// 允许请求方法</span></span><br><span class="line">        .maxAge(<span class="number">168000</span>)    <span class="comment">// 预检间隔时间</span></span><br><span class="line">        .allowedHeaders(<span class="string">"*"</span>)  <span class="comment">// 允许头部设置</span></span><br><span class="line">        .allowCredentials(<span class="keyword">true</span>);    <span class="comment">// 是否发送cookie</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Swagger配置类"><a href="#Swagger配置类" class="headerlink" title="Swagger配置类"></a>Swagger配置类</h3><p>Swagger配置类，除了常规配置外，加了一个令牌属性，可以在接口调用的时候传递令牌。</p>
<p>SwaggerConfig.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.config;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ParameterBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.schema.ModelRef;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Parameter;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Swagger配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="comment">// 添加请求参数，我们这里把token作为请求头部参数传入后端</span></span><br><span class="line">        ParameterBuilder parameterBuilder = <span class="keyword">new</span> ParameterBuilder();</span><br><span class="line">        List<Parameter> parameters = <span class="keyword">new</span> ArrayList<Parameter>();</span><br><span class="line">        parameterBuilder.name(<span class="string">"Authorization"</span>).description(<span class="string">"令牌"</span>).modelRef(<span class="keyword">new</span> ModelRef(<span class="string">"string"</span>)).parameterType(<span class="string">"header"</span>)</span><br><span class="line">                .required(<span class="keyword">false</span>).build();</span><br><span class="line">        parameters.add(parameterBuilder.build());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2).apiInfo(apiInfo()).select().apis(RequestHandlerSelectors.any())</span><br><span class="line">                .paths(PathSelectors.any()).build().globalOperationParameters(parameters);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder().build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>加了令牌属性后的 Swagger 接口调用界面。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128155349854-989402738.png" class="lozad"></p>
<h3 id="安全配置类"><a href="#安全配置类" class="headerlink" title="安全配置类"></a>安全配置类</h3><p>下面这个配置类是Spring Security的关键配置。</p>
<p>在这个配置类中，我们主要做了以下几个配置：</p>
<p>\1. 访问路径URL的授权策略，如登录、Swagger访问免登录认证等</p>
<p>\2. 指定了登录认证流程过滤器 JwtLoginFilter，由它来触发登录认证</p>
<p>\3. 指定了自定义身份认证组件 JwtAuthenticationProvider，并注入 UserDetailsService</p>
<p>\4. 指定了访问控制过滤器 JwtAuthenticationFilter，在授权时解析令牌和设置登录状态</p>
<p>\5. 指定了退出登录处理器，因为是前后端分离，防止内置的登录处理器在后台进行跳转</p>
<p>WebSecurityConfig.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.logout.HttpStatusReturningLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.security.JwtAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.security.JwtAuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.security.JwtLoginFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Security Config</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 使用自定义登录身份认证组件</span></span><br><span class="line">        auth.authenticationProvider(<span class="keyword">new</span> JwtAuthenticationProvider(userDetailsService));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// 禁用 csrf, 由于使用的是JWT，我们这里不需要csrf</span></span><br><span class="line">        http.cors().and().csrf().disable()</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            <span class="comment">// 跨域预检请求</span></span><br><span class="line">            .antMatchers(HttpMethod.OPTIONS, <span class="string">"/**"</span>).permitAll()</span><br><span class="line">            <span class="comment">// 登录URL</span></span><br><span class="line">            .antMatchers(<span class="string">"/login"</span>).permitAll()</span><br><span class="line">            <span class="comment">// swagger</span></span><br><span class="line">            .antMatchers(<span class="string">"/swagger-ui.html"</span>).permitAll()</span><br><span class="line">            .antMatchers(<span class="string">"/swagger-resources"</span>).permitAll()</span><br><span class="line">            .antMatchers(<span class="string">"/v2/api-docs"</span>).permitAll()</span><br><span class="line">            .antMatchers(<span class="string">"/webjars/springfox-swagger-ui/**"</span>).permitAll()</span><br><span class="line">            <span class="comment">// 其他所有请求需要身份认证</span></span><br><span class="line">            .anyRequest().authenticated();</span><br><span class="line">        <span class="comment">// 退出登录处理器</span></span><br><span class="line">        http.logout().logoutSuccessHandler(<span class="keyword">new</span> HttpStatusReturningLogoutSuccessHandler());</span><br><span class="line">        <span class="comment">// 开启登录认证流程过滤器</span></span><br><span class="line">        http.addFilterBefore(<span class="keyword">new</span> JwtLoginFilter(authenticationManager()), UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">// 访问控制时登录状态检查过滤器</span></span><br><span class="line">        http.addFilterBefore(<span class="keyword">new</span> JwtAuthenticationFilter(authenticationManager()), UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManager();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="登录认证触发过滤器"><a href="#登录认证触发过滤器" class="headerlink" title="登录认证触发过滤器"></a>登录认证触发过滤器</h3><p>JwtLoginFilter 是在通过访问 /login 的POST请求是被首先被触发的过滤器，默认实现是 UsernamePasswordAuthenticationFilter，它继承了 AbstractAuthenticationProcessingFilter，抽象父类的 doFilter 定义了登录认证的大致操作流程，这里我们的 JwtLoginFilter 继承了 UsernamePasswordAuthenticationFilter，并进行了两个主要内容的定制。</p>
<p>\1. 覆写认证方法，修改用户名、密码的获取方式，具体原因看代码注释</p>
<p>\2. 覆写认证成功后的操作，移除后台跳转，添加生成令牌并返回给客户端</p>
<p>JwtLoginFilter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.event.InteractiveAuthenticationSuccessEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.utils.HttpUtils;</span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.utils.JwtTokenUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动登录认证流程过滤器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtLoginFilter</span> <span class="keyword">extends</span> <span class="title">UsernamePasswordAuthenticationFilter</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtLoginFilter</span><span class="params">(AuthenticationManager authManager)</span> </span>{</span><br><span class="line">        setAuthenticationManager(authManager);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">        <span class="comment">// POST 请求 /login 登录时拦截， 由此方法触发执行登录认证流程，可以在此覆写整个登录认证逻辑</span></span><br><span class="line">        <span class="keyword">super</span>.doFilter(req, res, chain); </span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        <span class="comment">// 可以在此覆写尝试进行登录认证的逻辑，登录成功之后等操作不再此方法内</span></span><br><span class="line">        <span class="comment">// 如果使用此过滤器来触发登录认证流程，注意登录请求数据格式的问题</span></span><br><span class="line">        <span class="comment">// 此过滤器的用户名密码默认从request.getParameter()获取，但是这种</span></span><br><span class="line">        <span class="comment">// 读取方式不能读取到如 application/json 等 post 请求数据，需要把</span></span><br><span class="line">        <span class="comment">// 用户名密码的读取逻辑修改为到流中读取request.getInputStream()</span></span><br><span class="line"></span><br><span class="line">        String body = getBody(request);</span><br><span class="line">        JSONObject jsonObject = JSON.parseObject(body);</span><br><span class="line">        String username = jsonObject.getString(<span class="string">"username"</span>);</span><br><span class="line">        String password = jsonObject.getString(<span class="string">"password"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (username == <span class="keyword">null</span>) {</span><br><span class="line">            username = <span class="string">""</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (password == <span class="keyword">null</span>) {</span><br><span class="line">            password = <span class="string">""</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        username = username.trim();</span><br><span class="line"></span><br><span class="line">        JwtAuthenticatioToken authRequest = <span class="keyword">new</span> JwtAuthenticatioToken(username, password);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow subclasses to set the "details" property</span></span><br><span class="line">        setDetails(request, authRequest);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    </span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span></span></span><br><span class="line"><span class="function"><span class="params">            Authentication authResult)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">        <span class="comment">// 存储登录认证信息到上下文</span></span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authResult);</span><br><span class="line">        <span class="comment">// 记住我服务</span></span><br><span class="line">        getRememberMeServices().loginSuccess(request, response, authResult);</span><br><span class="line">        <span class="comment">// 触发事件监听器</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.eventPublisher != <span class="keyword">null</span>) {</span><br><span class="line">            eventPublisher.publishEvent(<span class="keyword">new</span> InteractiveAuthenticationSuccessEvent(authResult, <span class="keyword">this</span>.getClass()));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 生成并返回token给客户端，后续访问携带此token</span></span><br><span class="line">        JwtAuthenticatioToken token = <span class="keyword">new</span> JwtAuthenticatioToken(<span class="keyword">null</span>, <span class="keyword">null</span>, JwtTokenUtils.generateToken(authResult));</span><br><span class="line">        HttpUtils.write(response, token);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 获取请求Body</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBody</span><span class="params">(HttpServletRequest request)</span> </span>{</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader reader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            inputStream = request.getInputStream();</span><br><span class="line">            reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream, Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">            String line = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) {</span><br><span class="line">                sb.append(line);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    inputStream.close();</span><br><span class="line">                } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (reader != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    reader.close();</span><br><span class="line">                } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="登录控制器"><a href="#登录控制器" class="headerlink" title="登录控制器"></a>登录控制器</h3><p>除了使用上面的登录认证过滤器拦截 /login Post请求之外，我们也可以不使用上面的过滤器，通过自定义登录接口实现，只要在登录接口手动触发登录流程并生产令牌即可。</p>
<p>其实 Spring Security 的登录认证过程只需 调用 AuthenticationManager 的 authenticate(Authentication authentication) 方法，最终返回认证成功的 Authentication 实现类并存储到SpringContexHolder 上下文即可，这样后面授权的时候就可以从 SpringContexHolder 中获取登录认证信息，并根据其中的用户信息和权限信息决定是否进行授权。</p>
<p>LoginController.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.security.JwtAuthenticatioToken;</span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.utils.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.vo.HttpResult;</span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.vo.LoginBean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录控制器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">login</span><span class="params">(@RequestBody LoginBean loginBean, HttpServletRequest request)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        String username = loginBean.getUsername();</span><br><span class="line">        String password = loginBean.getPassword();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 系统登录认证</span></span><br><span class="line">        JwtAuthenticatioToken token = SecurityUtils.login(request, username, password, authenticationManager);</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> HttpResult.ok(token);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意：如果使用此登录控制器触发登录认证，需要禁用登录认证过滤器，即将 WebSecurityConfig 中的以下配置项注释即可，否则访问登录接口会被过滤拦截，执行不会再进入此登录接口，大家根据使用习惯二选一即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启登录认证流程过滤器，如果使用LoginController的login接口, 需要注释掉此过滤器，根据使用习惯二选一即可</span></span><br><span class="line">http.addFilterBefore(<span class="keyword">new</span> JwtLoginFilter(authenticationManager()), UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>如下是登录认证的逻辑， 可以看到部分逻辑跟上面的登录认证过滤器差不多。</p>
<p>\1. 执行登录认证过程，通过调用 AuthenticationManager 的 authenticate(token) 方法实现</p>
<p>\2. 将认证成功的认证信息存储到上下文，供后续访问授权的时候获取使用</p>
<p>\3. 通过JWT生成令牌并返回给客户端，后续访问和操作都需要携带此令牌</p>
<p>SecurityUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Security相关操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityUtils</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统登录认证</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authenticationManager</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JwtAuthenticatioToken <span class="title">login</span><span class="params">(HttpServletRequest request, String username, String password, AuthenticationManager authenticationManager)</span> </span>{</span><br><span class="line">        JwtAuthenticatioToken token = <span class="keyword">new</span> JwtAuthenticatioToken(username, password);</span><br><span class="line">        token.setDetails(<span class="keyword">new</span> WebAuthenticationDetailsSource().buildDetails(request));</span><br><span class="line">        <span class="comment">// 执行登录认证过程</span></span><br><span class="line">        Authentication authentication = authenticationManager.authenticate(token);</span><br><span class="line">        <span class="comment">// 认证成功存储认证信息到上下文</span></span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        <span class="comment">// 生成令牌并返回给客户端</span></span><br><span class="line">        token.setToken(JwtTokenUtils.generateToken(authentication));</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    }</span><br><span class="line">　　</span><br><span class="line">　　...</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="令牌生成器"><a href="#令牌生成器" class="headerlink" title="令牌生成器"></a>令牌生成器</h3><p>我们令牌是使用JWT生成的，下面是令牌生成的简要逻辑，详细参见源码。</p>
<p>JwtTokenUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JWT工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTokenUtils</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line"></span><br><span class="line">    ...<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成令牌</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDetails 用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateToken</span><span class="params">(Authentication authentication)</span> </span>{</span><br><span class="line">        Map<String, Object> claims = <span class="keyword">new</span> HashMap<>(<span class="number">3</span>);</span><br><span class="line">        claims.put(USERNAME, SecurityUtils.getUsername(authentication));</span><br><span class="line">        claims.put(CREATED, <span class="keyword">new</span> Date());</span><br><span class="line">        claims.put(AUTHORITIES, authentication.getAuthorities());</span><br><span class="line">        <span class="keyword">return</span> generateToken(claims);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从数据声明生成令牌</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> claims 数据声明</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">generateToken</span><span class="params">(Map<String, Object> claims)</span> </span>{</span><br><span class="line">        Date expirationDate = <span class="keyword">new</span> Date(System.currentTimeMillis() + EXPIRE_TIME);</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder().setClaims(claims).setExpiration(expirationDate).signWith(SignatureAlgorithm.HS512, SECRET).compact();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">　　...</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="登录身份认证组件"><a href="#登录身份认证组件" class="headerlink" title="登录身份认证组件"></a>登录身份认证组件</h3><p>上面说到登录认证是通过调用 AuthenticationManager 的 authenticate(token) 方法实现的，而 AuthenticationManager 又是通过调用 AuthenticationProvider 的 authenticate(Authentication authentication) 来完成认证的，所以通过定制 AuthenticationProvider 也可以完成各种自定义的需求，我们这里只是简单的继承 DaoAuthenticationProvider 展示如何自定义，具体的大家可以根据各自的需求按需定制。</p>
<p>JwtAuthenticationProvider.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.dao.DaoAuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 身份验证提供者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 20, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationProvider</span> <span class="keyword">extends</span> <span class="title">DaoAuthenticationProvider</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtAuthenticationProvider</span><span class="params">(UserDetailsService userDetailsService)</span> </span>{</span><br><span class="line">        setUserDetailsService(userDetailsService);</span><br><span class="line">        setPasswordEncoder(<span class="keyword">new</span> BCryptPasswordEncoder());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        <span class="comment">// 可以在此处覆写整个登录认证逻辑</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticate(authentication);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">additionalAuthenticationChecks</span><span class="params">(UserDetails userDetails, UsernamePasswordAuthenticationToken authentication)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        <span class="comment">// 可以在此处覆写密码验证逻辑</span></span><br><span class="line">        <span class="keyword">super</span>.additionalAuthenticationChecks(userDetails, authentication);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="认证信息获取服务"><a href="#认证信息获取服务" class="headerlink" title="认证信息获取服务"></a>认证信息获取服务</h3><p>通过跟踪代码运行，我们发现像默认使用的 DaoAuthenticationProvider，在认证的使用都是通过一个叫 UserDetailsService 的来获取用户认证所需信息的。</p>
<p>AbstractUserDetailsAuthenticationProvider 定义了在 authenticate 方法中通过 retrieveUser 方法获取用户信息，子类 DaoAuthenticationProvider 通过 UserDetailsService 来进行获取， 一般情况，这个 UserDetailsService 需要我们自定义，实现从用户服务获取用户和权限信息封装到 UserDetails 的实现类。</p>
<p>AbstractUserDetailsAuthenticationProvider.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        </span><br><span class="line">　　　　　...</span><br><span class="line"><span class="keyword">if</span> (user == <span class="keyword">null</span>) {</span><br><span class="line">            cacheWasUsed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);</span><br><span class="line">            }</span><br><span class="line">     </span><br><span class="line">        ...<span class="keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>DaoAuthenticationProvider.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> UserDetails <span class="title">retrieveUser</span><span class="params">(String username, UsernamePasswordAuthenticationToken authentication)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line"></span><br><span class="line">        UserDetails loadedUser = <span class="keyword">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line">   <span class="keyword">return</span> loadedUser;</span><br><span class="line">    }</span><br><span class="line">    ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们自定义的 UserDetailsService，从我们的用户服务 UserService 中获取用户和权限信息。</p>
<p>UserDetailsServiceImpl.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.security;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.model.User;</span><br><span class="line"><span class="keyword">import</span> com.louis.springboot.spring.security.service.UserService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登录认证信息查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 20, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>{</span><br><span class="line">        User user = userService.findByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"该用户不存在"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 用户权限列表，根据用户拥有的权限标识与如 @PreAuthorize("hasAuthority('sys:menu:view')") 标注的接口对比，决定是否可以调用接口</span></span><br><span class="line">        Set<String> permissions = userService.findPermissions(username);</span><br><span class="line">        List<GrantedAuthority> grantedAuthorities = permissions.stream().map(GrantedAuthorityImpl::<span class="keyword">new</span>).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtUserDetails(username, user.getPassword(), grantedAuthorities);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>一般而言，定制 UserDetailsService 就可以满足大部分需求了，在 UserDetailsService 满足不了我们的需求的时候考虑定制 AuthenticationProvider。</p>
<p>如果直接定制UserDetailsService ，而不自定义 AuthenticationProvider，可以直接在配置文件 WebSecurityConfig 中这样配置。</p>
<p>WebSecurityConfig.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// 指定自定义的获取信息获取服务</span></span><br><span class="line">    auth.userDetailsService(userDetailsService)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="用户认证信息"><a href="#用户认证信息" class="headerlink" title="用户认证信息"></a>用户认证信息</h3><p>上面 UserDetailsService 加载好用户认证信息后会封装认证信息到一个 UserDetails 的实现类。</p>
<p>默认实现是 User 类，我们这里没有特殊需要，简单继承即可，复杂需求可以在此基础上进行拓展。</p>
<p>JwtUserDetails.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.security;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全用户模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUserDetails</span> <span class="keyword">extends</span> <span class="title">User</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtUserDetails</span><span class="params">(String username, String password, Collection<? extends GrantedAuthority> authorities)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(username, password, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, authorities);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtUserDetails</span><span class="params">(String username, String password, <span class="keyword">boolean</span> enabled, <span class="keyword">boolean</span> accountNonExpired,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> credentialsNonExpired, <span class="keyword">boolean</span> accountNonLocked, Collection<? extends GrantedAuthority> authorities)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(username, password, enabled, accountNonExpired, credentialsNonExpired, accountNonLocked, authorities);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="用户操作代码"><a href="#用户操作代码" class="headerlink" title="用户操作代码"></a>用户操作代码</h3><p>简单的用户模型，包含用户名密码。</p>
<p>User.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.louis.springboot.spring.security.model;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>用户服务接口，只提供简单的用户查询和权限查询接口用于模拟。</p>
<p>UserService.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户管理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 28, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户名查找用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">User <span class="title">findByUsername</span><span class="params">(String username)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找用户的菜单权限标识集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Set<String> <span class="title">findPermissions</span><span class="params">(String username)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>用户服务实现，只简单获取返回模拟数据，实际场景根据情况从DAO获取即可。</p>
<p>SysUserServiceImpl.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysUserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findByUsername</span><span class="params">(String username)</span> </span>{</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">1L</span>);</span><br><span class="line">        user.setUsername(username);</span><br><span class="line">        String password = <span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"123"</span>);</span><br><span class="line">        user.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set<String> <span class="title">findPermissions</span><span class="params">(String username)</span> </span>{</span><br><span class="line">        Set<String> permissions = <span class="keyword">new</span> HashSet<>();</span><br><span class="line">        permissions.add(<span class="string">"sys:user:view"</span>);</span><br><span class="line">        permissions.add(<span class="string">"sys:user:add"</span>);</span><br><span class="line">        permissions.add(<span class="string">"sys:user:edit"</span>);</span><br><span class="line">        <span class="keyword">return</span> permissions;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>用户控制器，提供三个测试接口，其中权限列表中未包含删除接口定义的权限（’sys:user:delete’），登录之后也将无权限调用。</p>
<p>UserController.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户控制器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Oct 31, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>{</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize</span>(<span class="string">"hasAuthority('sys:user:view')"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(value=<span class="string">"/findAll"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">findAll</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> HttpResult.ok(<span class="string">"the findAll service is called success."</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize</span>(<span class="string">"hasAuthority('sys:user:edit')"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(value=<span class="string">"/edit"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">edit</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> HttpResult.ok(<span class="string">"the edit service is called success."</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreAuthorize</span>(<span class="string">"hasAuthority('sys:user:delete')"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(value=<span class="string">"/delete"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">delete</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> HttpResult.ok(<span class="string">"the delete service is called success."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="登录认证检查过滤器"><a href="#登录认证检查过滤器" class="headerlink" title="登录认证检查过滤器"></a>登录认证检查过滤器</h3><p>访问接口的时候，登录认证检查过滤器 JwtAuthenticationFilter 会拦截请求校验令牌和登录状态，并根据情况设置登录状态。</p>
<p>JwtAuthenticationFilter.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录认证检查过滤器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Louis</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> Nov 20, 2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">BasicAuthenticationFilter</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtAuthenticationFilter</span><span class="params">(AuthenticationManager authenticationManager)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(authenticationManager);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">        <span class="comment">// 获取token, 并检查登录状态</span></span><br><span class="line">        SecurityUtils.checkAuthentication(request);</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>SecurityUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取令牌进行认证</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkAuthentication</span><span class="params">(HttpServletRequest request)</span> </span>{</span><br><span class="line">    <span class="comment">// 获取令牌并根据令牌获取登录认证信息</span></span><br><span class="line">    Authentication authentication = JwtTokenUtils.getAuthenticationeFromToken(request);</span><br><span class="line">    <span class="comment">// 设置登录认证信息到上下文</span></span><br><span class="line">    SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>JwtTokenUtils.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据请求令牌获取登录认证信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> token 令牌</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 用户名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Authentication <span class="title">getAuthenticationeFromToken</span><span class="params">(HttpServletRequest request)</span> </span>{</span><br><span class="line">    Authentication authentication = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 获取请求携带的令牌</span></span><br><span class="line">    String token = JwtTokenUtils.getToken(request);</span><br><span class="line">    <span class="keyword">if</span>(token != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// 请求令牌不能为空</span></span><br><span class="line">        <span class="keyword">if</span>(SecurityUtils.getAuthentication() == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 上下文中Authentication为空</span></span><br><span class="line">            Claims claims = getClaimsFromToken(token);</span><br><span class="line">            <span class="keyword">if</span>(claims == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">            String username = claims.getSubject();</span><br><span class="line">            <span class="keyword">if</span>(username == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span>(isTokenExpired(token)) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">            Object authors = claims.get(AUTHORITIES);</span><br><span class="line">            List<GrantedAuthority> authorities = <span class="keyword">new</span> ArrayList<GrantedAuthority>();</span><br><span class="line">            <span class="keyword">if</span> (authors != <span class="keyword">null</span> && authors <span class="keyword">instanceof</span> List) {</span><br><span class="line">                <span class="keyword">for</span> (Object object : (List) authors) {</span><br><span class="line">                    authorities.add(<span class="keyword">new</span> GrantedAuthorityImpl((String) ((Map) object).get(<span class="string">"authority"</span>)));</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            authentication = <span class="keyword">new</span> JwtAuthenticatioToken(username, <span class="keyword">null</span>, authorities, token);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span>(validateToken(token, SecurityUtils.getUsername())) {</span><br><span class="line">                <span class="comment">// 如果上下文中Authentication非空，且请求令牌合法，直接返回当前登录认证信息</span></span><br><span class="line">                authentication = SecurityUtils.getAuthentication();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> authentication;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h3><p>找到 SpringSecurityApplication， 启动程序， 访问 <a href="http://localhost:8080/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8080/swagger-ui.html</a>，进入Swagger。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128173706668-177381559.png" class="lozad"></p>
<p>我们先再未登录没有令牌的时候直接访问接口，发现都返回无权限，禁止访问的结果。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128173840193-199335952.png" class="lozad"></p>
<p>返回拒绝访问结果。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128174042582-676639129.png" class="lozad"></p>
<p> 打开 LoginController，输入我们用户名和密码（username:amdin, password:123）</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128174231451-1027667004.png" class="lozad"></p>
<p> 登录成功之后，成功返回令牌，如下图所示。</p>
<p> <img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128174436613-252448914.png" class="lozad"></p>
<p>拷贝返回的令牌，粘贴到令牌参数输入框，再次访问 /user/edit 接口。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128174642788-1883486292.png" class="lozad"></p>
<p>这个时候，成功的返回了结果： the edit service is called success.</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128174754351-925193390.png" class="lozad"></p>
<p>同样的，拷贝返回的令牌，粘贴到令牌参数输入框，访问 /user/delete 接口。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128174924465-934756567.png" class="lozad"></p>
<p>发现还是返回拒绝访问的结果，那是因为访问这个接口需要 ‘sys:user:delete’ 权限，而我们之前返回的权限列表中并没有包含，所以授权访问失败。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128175018727-518353637.png" class="lozad"></p>
<p>我们修改一下 SysUserServiceImpl，添加上‘sys:user:delete’ 权限，重新登录，再次访问一遍。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128175401465-494777099.png" class="lozad"></p>
<p>发现删除接口也可以访问了，记住务必要重新调用登录接口，获取令牌后拷贝到删除接口，再次访问删除接口。</p>
<p><img alt="img" data-src="https://img2018.cnblogs.com/blog/616891/201811/616891-20181128175606389-1013803667.png" class="lozad"></p>
<p>到此，Spring Security 的讲解就结束了，本人知识有限，有不正确的地方，烦请指正，不尽感激。</p>
<h2 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h2><p>码云：<a href="https://gitee.com/liuge1988/spring-boot-demo.git" target="_blank" rel="noopener">https://gitee.com/liuge1988/spring-boot-demo.git</a></p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Huang Qingshan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://alifebug.github.io/2020/12/11/SpringSecurity%E5%85%A8%E8%A7%A3%E6%9E%90/">http://alifebug.github.io/2020/12/11/SpringSecurity%E5%85%A8%E8%A7%A3%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://ALifeBug.github.io">ALifeBug</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringSecurity/">SpringSecurity    </a></div><div class="post_share"><div class="social-share" data-image="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.png"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.png"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/11/PO%E3%80%81POJO%E3%80%81BO%E3%80%81VO%E3%80%81DTO%E3%80%81DAO%E5%8C%BA%E5%88%AB%E4%B8%8E%E8%81%94%E7%B3%BB/"><img class="prev_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>PO、POJO、BO、VO、DTO、DAO区别与联系</span></div></a></div><div class="next-post pull-right"><a href="/2020/12/11/SpringSecurity%E6%95%B4%E5%90%88JWT/"><img class="next_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>SpringSecurity整合JWT</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/12/11/SpringSecurity整合JWT/" title="SpringSecurity整合JWT"><img class="relatedPosts_cover lozad"data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><div class="relatedPosts_title">SpringSecurity整合JWT</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2020 By Huang Qingshan</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>