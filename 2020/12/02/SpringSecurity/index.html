<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>SpringSecurity | ALifeBug</title><meta name="description" content="SpringSecurity"><meta name="keywords" content=""><meta name="author" content="Huang Qingshan"><meta name="copyright" content="Huang Qingshan"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://alifebug.github.io/2020/12/02/SpringSecurity/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="SpringSecurity"><meta name="twitter:description" content="SpringSecurity"><meta name="twitter:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta property="og:type" content="article"><meta property="og:title" content="SpringSecurity"><meta property="og:url" content="http://alifebug.github.io/2020/12/02/SpringSecurity/"><meta property="og:site_name" content="ALifeBug"><meta property="og:description" content="SpringSecurity"><meta property="og:image" content="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="next" title="Hutool工具包" href="http://alifebug.github.io/2020/11/25/Hutool%E5%B7%A5%E5%85%B7%E5%8C%85/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">ALifeBug</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">19</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">22</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">12</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#SpringSecurity"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">SpringSecurity</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#初次使用"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">初次使用</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#自定义用户名密码"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">自定义用户名密码</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#自定义实现类"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">自定义实现类</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#使用数据库"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">使用数据库:</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#自定义登录页面"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">自定义登录页面:</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#基于角色和权限进行访问控制，没有权限时返回403"><span class="toc_mobile_items-number">1.6.</span> <span class="toc_mobile_items-text">基于角色和权限进行访问控制，没有权限时返回403</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#自定义403页面："><span class="toc_mobile_items-number">1.7.</span> <span class="toc_mobile_items-text">自定义403页面：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#使用注解"><span class="toc_mobile_items-number">1.8.</span> <span class="toc_mobile_items-text">使用注解</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#用户注销"><span class="toc_mobile_items-number">1.9.</span> <span class="toc_mobile_items-text">用户注销</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#自动登录"><span class="toc_mobile_items-number">1.10.</span> <span class="toc_mobile_items-text">自动登录</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#SpringSecurity微服务权限方案"><span class="toc_mobile_items-number">1.11.</span> <span class="toc_mobile_items-text">SpringSecurity微服务权限方案</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#SpringSecurity原理说明"><span class="toc_mobile_items-number">1.12.</span> <span class="toc_mobile_items-text">SpringSecurity原理说明</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringSecurity"><span class="toc-number">1.</span> <span class="toc-text">SpringSecurity</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初次使用"><span class="toc-number">1.1.</span> <span class="toc-text">初次使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义用户名密码"><span class="toc-number">1.2.</span> <span class="toc-text">自定义用户名密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义实现类"><span class="toc-number">1.3.</span> <span class="toc-text">自定义实现类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用数据库"><span class="toc-number">1.4.</span> <span class="toc-text">使用数据库:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义登录页面"><span class="toc-number">1.5.</span> <span class="toc-text">自定义登录页面:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于角色和权限进行访问控制，没有权限时返回403"><span class="toc-number">1.6.</span> <span class="toc-text">基于角色和权限进行访问控制，没有权限时返回403</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义403页面："><span class="toc-number">1.7.</span> <span class="toc-text">自定义403页面：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用注解"><span class="toc-number">1.8.</span> <span class="toc-text">使用注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用户注销"><span class="toc-number">1.9.</span> <span class="toc-text">用户注销</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自动登录"><span class="toc-number">1.10.</span> <span class="toc-text">自动登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringSecurity微服务权限方案"><span class="toc-number">1.11.</span> <span class="toc-text">SpringSecurity微服务权限方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringSecurity原理说明"><span class="toc-number">1.12.</span> <span class="toc-text">SpringSecurity原理说明</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">SpringSecurity</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-12-02<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-12-04</time><div class="post-meta-wordcount"><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="SpringSecurity"><a href="#SpringSecurity" class="headerlink" title="SpringSecurity"></a>SpringSecurity</h1><h2 id="初次使用"><a href="#初次使用" class="headerlink" title="初次使用"></a>初次使用</h2><p>导入依赖</p>
<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><dependency></span><br><span class="line">     <groupId>org.springframework.boot</groupId></span><br><span class="line">     <artifactId>spring-boot-starter-security</artifactId></span><br><span class="line"> </dependency></span><br></pre></td></tr></tbody></table></figure>

<p>创建controller</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>启动访问<a href="localhost:8080/hello">localhost:8080/hello</a>,会重定向到<a href="http://localhost:8080/login" target="_blank" rel="noopener">http://localhost:8080/login</a></p>
<p><a href="https://imgchr.com/i/DIFneO" target="_blank" rel="noopener"><img alt="DIFneO.png" data-src="https://s3.ax1x.com/2020/12/02/DIFneO.png" class="lozad"></a></p>
<p>初始用户名为user,密码打印在启动的后台，每次启动都会变：</p>
<p>Using generated security password: bc0feffd-697f-404e-a219-c18beedf60a4</p>
<h2 id="自定义用户名密码"><a href="#自定义用户名密码" class="headerlink" title="自定义用户名密码"></a>自定义用户名密码</h2><ul>
<li>在配置文件中配置：</li>
</ul>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">javaboy</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">123</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>配置类配置用户名密码:</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>{</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    auth.inMemoryAuthentication()</span><br><span class="line">    .withUser(<span class="string">"javaboy"</span>).roles(<span class="string">"admin"</span>)</span><br><span class="line">    .password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"123"</span>))</span><br><span class="line">    .and()</span><br><span class="line">    .withUser(<span class="string">"lisi"</span>).roles(<span class="string">"user"</span>)</span><br><span class="line">    .password(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"123"</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="自定义实现类"><a href="#自定义实现类" class="headerlink" title="自定义实现类"></a>自定义实现类</h2><ul>
<li>创建配置类，设置使用哪个UserDetailsService实现类</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>{</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserDetailsService userDetailsService; </span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>{</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>编写实现类，返回User对象，User对象有用户名密码和权限</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span>(<span class="string">"userDetailsService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>{</span><br><span class="line">        List<GrantedAuthority> auths = 		       	AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"role"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"mary"</span>,<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"123"</span>),auths);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="使用数据库"><a href="#使用数据库" class="headerlink" title="使用数据库:"></a>使用数据库:</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Users</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UsersMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span><<span class="title">Users</span>> </span>{</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"me.sccy.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityApplication</span> </span>{</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">    SpringApplication.run(SecurityApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"userDetailsService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>{</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UsersMapper usersMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>{</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询数据库</span></span><br><span class="line">        QueryWrapper<Users> wrapper = <span class="keyword">new</span> QueryWrapper<>();</span><br><span class="line">        wrapper.eq(<span class="string">"username"</span>,username);</span><br><span class="line">        Users users = usersMapper.selectOne(wrapper);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(users==<span class="keyword">null</span>){</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"用户名不存在"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        List<GrantedAuthority> auths = </span><br><span class="line">        AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"role"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(users.getUsername(),</span><br><span class="line">        <span class="keyword">new</span> BCryptPasswordEncoder().encode(users.getPassword()),auths);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="自定义登录页面"><a href="#自定义登录页面" class="headerlink" title="自定义登录页面:"></a>自定义登录页面:</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>{</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    	auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>{</span><br><span class="line">    	<span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        http.formLogin() <span class="comment">//自定义自己编写的登录页面</span></span><br><span class="line">        .loginPage(<span class="string">"/login.html"</span>) <span class="comment">//登录页面设置</span></span><br><span class="line">        .loginProcessingUrl(<span class="string">"/user/login"</span>) <span class="comment">//登录访问路径</span></span><br><span class="line">        .defaultSuccessUrl(<span class="string">"/index"</span>).permitAll()  <span class="comment">//登陆成功后跳转</span></span><br><span class="line">        .and().authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/"</span>,<span class="string">"/hello"</span>,<span class="string">"/user/login"</span>).permitAll() <span class="comment">//设置哪些路径可以直接访问，不需要认证</span></span><br><span class="line">        .anyRequest().authenticated()</span><br><span class="line">        .and().csrf().disable(); <span class="comment">//关闭csrf防护</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/index"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span></span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><!DOCTYPE <span class="meta-keyword">html</span>></span></span><br><span class="line"><span class="tag"><<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>></span></span><br><span class="line"><span class="tag"><<span class="name">head</span>></span></span><br><span class="line"><span class="tag"><<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>></span></span><br><span class="line"><span class="tag"><<span class="name">title</span>></span>Title<span class="tag"></<span class="name">title</span>></span></span><br><span class="line"><span class="tag"></<span class="name">head</span>></span></span><br><span class="line"><span class="tag"><<span class="name">body</span>></span></span><br><span class="line"><span class="tag"><<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/user/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>></span></span><br><span class="line">用户名：<span class="tag"><<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span>></span> //name必须是username</span><br><span class="line"><span class="tag"><<span class="name">br</span>/></span></span><br><span class="line">密码：<span class="tag"><<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"password"</span>></span> //name必须是password</span><br><span class="line"><span class="tag"><<span class="name">br</span>/></span></span><br><span class="line"><span class="tag"><<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"login"</span>/></span></span><br><span class="line"><span class="tag"></<span class="name">form</span>></span></span><br><span class="line"><span class="tag"></<span class="name">body</span>></span></span><br><span class="line"><span class="tag"></<span class="name">html</span>></span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="基于角色和权限进行访问控制，没有权限时返回403"><a href="#基于角色和权限进行访问控制，没有权限时返回403" class="headerlink" title="基于角色和权限进行访问控制，没有权限时返回403"></a>基于角色和权限进行访问控制，没有权限时返回403</h2><p>hasAuthority(只能设置一个权限)：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    http.formLogin() <span class="comment">//自定义自己编写的登录页面</span></span><br><span class="line">        .loginPage(<span class="string">"/login.html"</span>) <span class="comment">//登录页面设置</span></span><br><span class="line">        .loginProcessingUrl(<span class="string">"/user/login"</span>) <span class="comment">//登录访问路径</span></span><br><span class="line">        .defaultSuccessUrl(<span class="string">"/index"</span>).permitAll()  <span class="comment">//登陆成功后跳转</span></span><br><span class="line">        .and().authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">"/"</span>,<span class="string">"/hello"</span>,<span class="string">"/user/login"</span>).permitAll() <span class="comment">//设置哪些路径可以直接访问，不需要认证</span></span><br><span class="line">        .antMatchers(<span class="string">"/index"</span>).hasAuthority(<span class="string">"admins"</span>)<span class="comment">//只有admin用户可以访问index</span></span><br><span class="line">        .anyRequest().authenticated()   </span><br><span class="line">        .and().csrf().disable(); <span class="comment">//关闭csrf防护</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List<GrantedAuthority> auths = AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"admins"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>hasAnyAuthority(设置多个权限可访问):</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(<span class="string">"/index"</span>).hasAnyAuthority(<span class="string">"admins,manager"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>hasRole:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(<span class="string">"/index"</span>).hasRole(<span class="string">"sale"</span>) <span class="comment">// "hasRole('ROLE_" + role + "')",源码中加了前缀，所以授权角色要加ROLE_前缀</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List<GrantedAuthority> auths = AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"admins,ROLE_sale"</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>hasAnyRole:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers().hasAnyRole(<span class="string">"admin,sale"</span>)</span><br></pre></td></tr></tbody></table></figure>

<h2 id="自定义403页面："><a href="#自定义403页面：" class="headerlink" title="自定义403页面："></a>自定义403页面：</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置无权限访问跳转自定义页面</span></span><br><span class="line">http.exceptionHandling().accessDeniedPage(<span class="string">"/unauth.html"</span>);</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><!DOCTYPE <span class="meta-keyword">html</span>></span></span><br><span class="line"><span class="tag"><<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>></span></span><br><span class="line"><span class="tag"><<span class="name">head</span>></span></span><br><span class="line"><span class="tag"><<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>></span></span><br><span class="line"><span class="tag"><<span class="name">title</span>></span>Title<span class="tag"></<span class="name">title</span>></span></span><br><span class="line"><span class="tag"></<span class="name">head</span>></span></span><br><span class="line"><span class="tag"><<span class="name">body</span>></span></span><br><span class="line"><span class="tag"><<span class="name">h1</span>></span>没有访问权限<span class="tag"></<span class="name">h1</span>></span></span><br><span class="line"><span class="tag"></<span class="name">body</span>></span></span><br><span class="line"><span class="tag"></<span class="name">html</span>></span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="使用注解"><a href="#使用注解" class="headerlink" title="使用注解"></a>使用注解</h2><p>@Secured：用户拥有角色可以访问</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(securedEnabled = <span class="keyword">true</span>)<span class="comment">// 开启注解功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityApplication</span> </span>{</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line"><span class="meta">@Secured</span>({<span class="string">"ROLE_sale"</span>,<span class="string">"ROLE_manager"</span>})</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"update"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>@PreAuthorize：进入方法前验证</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(securedEnabled = <span class="keyword">true</span>,prePostEnabled = <span class="keyword">true</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasAnyAuthority('admins')"</span>)<span class="comment">//hasAnyAuthority,hasRole,hasAnyRole</span></span><br></pre></td></tr></tbody></table></figure>

<p>@PostAuthorize：在方法执行之后再校验</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(securedEnabled = <span class="keyword">true</span>,prePostEnabled = <span class="keyword">true</span>)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line"><span class="comment">//@Secured({"ROLE_sale","ROLE_manager"})</span></span><br><span class="line"><span class="comment">//@PreAuthorize("hasAnyAuthority('admins')")</span></span><br><span class="line"><span class="meta">@PostAuthorize</span>(<span class="string">"hasAnyAuthority('admins')"</span>) <span class="comment">//先执行再校验，决定要不要返回</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">()</span></span>{</span><br><span class="line">    System.out.println(<span class="string">"update..."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"update"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="用户注销"><a href="#用户注销" class="headerlink" title="用户注销"></a>用户注销</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//退出</span></span><br><span class="line">http.logout().logoutUrl(<span class="string">"/logout"</span>).logoutSuccessUrl(<span class="string">"/hello"</span>).permitAll();</span><br><span class="line">http.formLogin() <span class="comment">//自定义自己编写的登录页面</span></span><br><span class="line">    .loginPage(<span class="string">"/login.html"</span>) <span class="comment">//登录页面设置</span></span><br><span class="line">    .loginProcessingUrl(<span class="string">"/user/login"</span>) <span class="comment">//登录访问路径</span></span><br><span class="line">    .defaultSuccessUrl(<span class="string">"/success.html"</span>).permitAll()  <span class="comment">//登陆成功后跳转</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="自动登录"><a href="#自动登录" class="headerlink" title="自动登录"></a>自动登录</h2><p>原理图：</p>
<p><a href="https://imgchr.com/i/DoERaT" target="_blank" rel="noopener"><img alt="DoERaT.png" data-src="https://s3.ax1x.com/2020/12/02/DoERaT.png" class="lozad"></a></p>
<p>创建数据库persistent_logins(springsecurity会自动创建)</p>
<p>配置类中注入数据源</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PersistentTokenRepository <span class="title">persistentTokenRepository</span><span class="params">()</span></span>{</span><br><span class="line">    JdbcTokenRepositoryImpl jdbcTokenRepository = <span class="keyword">new</span> JdbcTokenRepositoryImpl();</span><br><span class="line">    jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">    jdbcTokenRepository.setCreateTableOnStartup(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">.and().rememberMe().tokenRepository(persistentTokenRepository())</span><br><span class="line">      .tokenValiditySeconds(<span class="number">60</span>)<span class="comment">//有效时长，秒为单位</span></span><br><span class="line">      .userDetailsService(userDetailsService)</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag"><<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"remember-me"</span>></span>自动登录 //name必须为remember-me</span><br></pre></td></tr></tbody></table></figure>



<h2 id="SpringSecurity微服务权限方案"><a href="#SpringSecurity微服务权限方案" class="headerlink" title="SpringSecurity微服务权限方案"></a>SpringSecurity微服务权限方案</h2><p><a href="https://imgchr.com/i/DouKat" target="_blank" rel="noopener"><img alt="DouKat.png" data-src="https://s3.ax1x.com/2020/12/02/DouKat.png" class="lozad"></a></p>
<h2 id="SpringSecurity原理说明"><a href="#SpringSecurity原理说明" class="headerlink" title="SpringSecurity原理说明"></a>SpringSecurity原理说明</h2><p>总体流程：SpringSecurity 采用的是责任链的设计模式，它有一条很长的过滤器链。</p>
<p><a href="https://imgchr.com/i/DbuUiR" target="_blank" rel="noopener"><img alt="DbuUiR.jpg" data-src="https://s3.ax1x.com/2020/12/04/DbuUiR.jpg" class="lozad"></a></p>
<p>（1） <strong>WebAsyncManagerIntegrationFilter</strong>：将 Security 上下文与 Spring Web 中用于<br>处理异步请求映射的 WebAsyncManager 进行集成。<br>（2） <strong>SecurityContextPersistenceFilter</strong>：在每次请求处理之前将该请求相关的安全上<br>下文信息加载到 SecurityContextHolder 中，然后在该次请求处理完成之后，将<br>SecurityContextHolder 中关于这次请求的信息存储到一个“仓储”中，然后将<br>SecurityContextHolder 中的信息清除，例如在 Session 中维护一个用户的安全信<br>息就是这个过滤器处理的。<br>（3） <strong>HeaderWriterFilter</strong>：用于将头信息加入响应中。<br>（4） <strong>CsrfFilter</strong>：用于处理跨站请求伪造。<br>（5）<strong>LogoutFilter</strong>：用于处理退出登录。<br>（6）<strong>UsernamePasswordAuthenticationFilter</strong>：用于处理基于表单的登录请求，从表单中<br>获取用户名和密码。默认情况下处理来自 /login 的请求。从表单中获取用户名和密码<br>时，默认使用的表单 name 值为 username 和 password，这两个值可以通过设置这个<br>过滤器的 usernameParameter 和 passwordParameter 两个参数的值进行修改。<br>（7）<strong>DefaultLoginPageGeneratingFilter</strong>：如果没有配置登录页面，那系统初始化时就会<br>配置这个过滤器，并且用于在需要进行登录时生成一个登录表单页面。<br>（8）<strong>BasicAuthenticationFilter</strong>：检测和处理 http basic 认证。<br>（9）<strong>RequestCacheAwareFilter</strong>：用来处理请求的缓存。<br>（10）<strong>SecurityContextHolderAwareRequestFilter</strong>：主要是包装请求对象 request。<br>（11）<strong>AnonymousAuthenticationFilter</strong>：检测 SecurityContextHolder 中是否存在<br>Authentication 对象，如果不存在为其提供一个匿名 Authentication。<br>（12）<strong>SessionManagementFilter</strong>：管理 session 的过滤器<br>（13）<strong>ExceptionTranslationFilter</strong>：处理 AccessDeniedException 和<br>AuthenticationException 异常。<br>（14）<strong>FilterSecurityInterceptor</strong>：可以看做过滤器链的出口。该过滤器是过滤器链的最后一个过滤器，根据资源<br>权限配置来判断当前请求是否有权限访问对应的资源。如果访问受限会抛出相关异常，并<br>由 ExceptionTranslationFilter 过滤器进行捕获和处理。<br>（15）<strong>RememberMeAuthenticationFilter</strong>：当用户没有登录而直接访问资源时, 从 cookie<br>里找出用户的信息, 如果 Spring Security 能够识别出用户提供的 remember me cookie,<br>用户将不必填写用户名和密码, 而是直接登录进入系统，该过滤器默认不开启。</p>
<p>流程说明：</p>
<ol>
<li>客户端发起一个请求，进入 Security 过滤器链。</li>
<li>当到 LogoutFilter 的时候判断是否是登出路径，如果是登出路径则到 logoutHandler ，如果登出成功则到 logoutSuccessHandler 登出成功处理，如果登出失败则由 ExceptionTranslationFilter ；如果不是登出路径则直接进入下一个过滤器。</li>
<li>当到 UsernamePasswordAuthenticationFilter 的时候判断是否为登录路径，如果是，则进入该过滤器进行登录操作，如果登录失败则到 AuthenticationFailureHandler 登录失败处理器处理，如果登录成功则到 AuthenticationSuccessHandler 登录成功处理器处理，如果不是登录请求则不进入该过滤器。</li>
<li>当到 FilterSecurityInterceptor 的时候会拿到 uri ，根据 uri 去找对应的鉴权管理器，鉴权管理器做鉴权工作，鉴权成功则到 Controller 层否则到 AccessDeniedHandler 鉴权失败处理器处理。</li>
</ol>
<p><strong>认证流程</strong></p>
<p><a href="https://imgchr.com/i/DbDbKU" target="_blank" rel="noopener"><img alt="DbDbKU.png" data-src="https://s3.ax1x.com/2020/12/04/DbDbKU.png" class="lozad"></a></p>
<p><a href="https://imgchr.com/i/DbYK76" target="_blank" rel="noopener"><img alt="DbYK76.jpg" data-src="https://s3.ax1x.com/2020/12/04/DbYK76.jpg" class="lozad"></a></p>
<p><a href="https://imgchr.com/i/DbY6js" target="_blank" rel="noopener"><img alt="DbY6js.jpg" data-src="https://s3.ax1x.com/2020/12/04/DbY6js.jpg" class="lozad"></a></p>
<p><strong>主要代码：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAuthenticationProcessingFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span></span></span><br><span class="line"><span class="class"><span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span>, <span class="title">MessageSourceAware</span> </span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">        doFilter((HttpServletRequest) request, (HttpServletResponse) response, chain);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">        <span class="keyword">if</span> (!requiresAuthentication(request, response)) {</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Authentication authenticationResult = attemptAuthentication(request, response);</span><br><span class="line">            <span class="keyword">if</span> (authenticationResult == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// return immediately as subclass has indicated that it hasn't completed</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">this</span>.sessionStrategy.onAuthentication(authenticationResult, request, response);</span><br><span class="line">            <span class="comment">// Authentication success</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.continueChainBeforeSuccessfulAuthentication) {</span><br><span class="line">                chain.doFilter(request, response);</span><br><span class="line">            }</span><br><span class="line">            successfulAuthentication(request, response, chain, authenticationResult);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (InternalAuthenticationServiceException failed) {</span><br><span class="line">            <span class="keyword">this</span>.logger.error(<span class="string">"An internal error occurred while trying to authenticate the user."</span>, failed);</span><br><span class="line">            unsuccessfulAuthentication(request, response, failed);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (AuthenticationException ex) {</span><br><span class="line">            <span class="comment">// Authentication failed</span></span><br><span class="line">            unsuccessfulAuthentication(request, response, ex);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, 		</span></span></span><br><span class="line"><span class="function"><span class="params">    HttpServletResponse response)</span><span class="keyword">throws</span> AuthenticationException, IOException, ServletException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsernamePasswordAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span> </span>{</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_SECURITY_FORM_USERNAME_KEY = <span class="string">"username"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_SECURITY_FORM_PASSWORD_KEY = <span class="string">"password"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AntPathRequestMatcher DEFAULT_ANT_PATH_REQUEST_MATCHER = <span class="keyword">new</span> AntPathRequestMatcher(<span class="string">"/login"</span>,</span><br><span class="line">			<span class="string">"POST"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String usernameParameter = SPRING_SECURITY_FORM_USERNAME_KEY;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String passwordParameter = SPRING_SECURITY_FORM_PASSWORD_KEY;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> postOnly = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">UsernamePasswordAuthenticationFilter</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">super</span>(DEFAULT_ANT_PATH_REQUEST_MATCHER);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">UsernamePasswordAuthenticationFilter</span><span class="params">(AuthenticationManager authenticationManager)</span> </span>{</span><br><span class="line">		<span class="keyword">super</span>(DEFAULT_ANT_PATH_REQUEST_MATCHER, authenticationManager);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse 	  </span></span></span><br><span class="line"><span class="function"><span class="params">                                                response)</span><span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.postOnly && !request.getMethod().equals(<span class="string">"POST"</span>)) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">"Authentication method not supported: "</span> + </span><br><span class="line">             request.getMethod());</span><br><span class="line">		}</span><br><span class="line">		String username = obtainUsername(request);</span><br><span class="line">		username = (username != <span class="keyword">null</span>) ? username : <span class="string">""</span>;</span><br><span class="line">		username = username.trim();</span><br><span class="line">		String password = obtainPassword(request);</span><br><span class="line">		password = (password != <span class="keyword">null</span>) ? password : <span class="string">""</span>;</span><br><span class="line">		UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> </span><br><span class="line">			UsernamePasswordAuthenticationToken(username, password);</span><br><span class="line">		<span class="comment">// Allow subclasses to set the "details" property</span></span><br><span class="line">		setDetails(request, authRequest);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UsernamePasswordAuthenticationToken</span><span class="params">(Object principal, Object credentials)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>((Collection)<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        <span class="keyword">this</span>.credentials = credentials;</span><br><span class="line">        <span class="keyword">this</span>.setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UsernamePasswordAuthenticationToken</span><span class="params">(Object principal, Object credentials, Collection<? 					extends GrantedAuthority> authorities)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(authorities);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        <span class="keyword">this</span>.credentials = credentials;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">true</span>);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>{</span><br><span class="line">    Collection<? extends GrantedAuthority> getAuthorities();</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>{</span><br><span class="line">        Class<? extends Authentication> toTest = authentication.getClass();</span><br><span class="line">        AuthenticationException lastException = <span class="keyword">null</span>;</span><br><span class="line">        AuthenticationException parentException = <span class="keyword">null</span>;</span><br><span class="line">        Authentication result = <span class="keyword">null</span>;</span><br><span class="line">        Authentication parentResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> currentPosition = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> size = <span class="keyword">this</span>.providers.size();</span><br><span class="line">        Iterator var9 = <span class="keyword">this</span>.getProviders().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var9.hasNext()) {</span><br><span class="line">            AuthenticationProvider provider = (AuthenticationProvider)var9.next();</span><br><span class="line">            <span class="keyword">if</span> (provider.supports(toTest)) {</span><br><span class="line">                <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">                    Log var10000 = logger;</span><br><span class="line">                    String var10002 = provider.getClass().getSimpleName();</span><br><span class="line">                    ++currentPosition;</span><br><span class="line">                    var10000.trace(LogMessage.format(<span class="string">"Authenticating request with %s (%d/%d)"</span>, var10002, currentPosition, size));</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    result = provider.authenticate(authentication);</span><br><span class="line">                    <span class="keyword">if</span> (result != <span class="keyword">null</span>) {</span><br><span class="line">                        <span class="keyword">this</span>.copyDetails(authentication, result);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (InternalAuthenticationServiceException | AccountStatusException var14) {</span><br><span class="line">                    <span class="keyword">this</span>.prepareException(var14, authentication);</span><br><span class="line">                    <span class="keyword">throw</span> var14;</span><br><span class="line">                } <span class="keyword">catch</span> (AuthenticationException var15) {</span><br><span class="line">                    lastException = var15;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span> && <span class="keyword">this</span>.parent != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                parentResult = <span class="keyword">this</span>.parent.authenticate(authentication);</span><br><span class="line">                result = parentResult;</span><br><span class="line">            } <span class="keyword">catch</span> (ProviderNotFoundException var12) {</span><br><span class="line">            } <span class="keyword">catch</span> (AuthenticationException var13) {</span><br><span class="line">                parentException = var13;</span><br><span class="line">                lastException = var13;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.eraseCredentialsAfterAuthentication && result <span class="keyword">instanceof</span> CredentialsContainer) {</span><br><span class="line">                ((CredentialsContainer)result).eraseCredentials();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (parentResult == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">this</span>.eventPublisher.publishAuthenticationSuccess(result);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span> (lastException == <span class="keyword">null</span>) {</span><br><span class="line">                lastException = <span class="keyword">new</span> ProviderNotFoundException(<span class="keyword">this</span>.messages.getMessage(<span class="string">"ProviderManager.providerNotFound"</span>, <span class="keyword">new</span> Object[]{toTest.getName()}, <span class="string">"No AuthenticationProvider found for {0}"</span>));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (parentException == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">this</span>.prepareException((AuthenticationException)lastException, authentication);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> lastException;</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span></span></span><br><span class="line"><span class="function"><span class="params">			Authentication authResult)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">		SecurityContextHolder.getContext().setAuthentication(authResult);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) {</span><br><span class="line">			<span class="keyword">this</span>.logger.debug(LogMessage.format(<span class="string">"Set SecurityContextHolder to %s"</span>, authResult));</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">this</span>.rememberMeServices.loginSuccess(request, response, authResult);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.eventPublisher != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">this</span>.eventPublisher.publishEvent(<span class="keyword">new</span> InteractiveAuthenticationSuccessEvent(authResult, <span class="keyword">this</span>.getClass()));</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">this</span>.successHandler.onAuthenticationSuccess(request, response, authResult);</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">unsuccessfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">			AuthenticationException failed)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">		SecurityContextHolder.clearContext();</span><br><span class="line">		<span class="keyword">this</span>.logger.trace(<span class="string">"Failed to process authentication request"</span>, failed);</span><br><span class="line">		<span class="keyword">this</span>.logger.trace(<span class="string">"Cleared SecurityContextHolder"</span>);</span><br><span class="line">		<span class="keyword">this</span>.logger.trace(<span class="string">"Handling authentication failure"</span>);</span><br><span class="line">		<span class="keyword">this</span>.rememberMeServices.loginFail(request, response);</span><br><span class="line">		<span class="keyword">this</span>.failureHandler.onAuthenticationFailure(request, response, failed);</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>权限访问流程：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityContextPersistenceFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span> </span>{</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, ServletException </span>{</span><br><span class="line">		<span class="comment">// ensure that filter is only applied once per request</span></span><br><span class="line">		<span class="keyword">if</span> (request.getAttribute(FILTER_APPLIED) != <span class="keyword">null</span>) {</span><br><span class="line">			chain.doFilter(request, response);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		}</span><br><span class="line">		request.setAttribute(FILTER_APPLIED, Boolean.TRUE);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.forceEagerSessionCreation) {</span><br><span class="line">			HttpSession session = request.getSession();</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled() && session.isNew()) {</span><br><span class="line">				<span class="keyword">this</span>.logger.debug(LogMessage.format(<span class="string">"Created session %s eagerly"</span>, session.getId()));</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		HttpRequestResponseHolder holder = <span class="keyword">new</span> HttpRequestResponseHolder(request, response);</span><br><span class="line">		SecurityContext contextBeforeChainExecution = <span class="keyword">this</span>.repo.loadContext(holder);</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			SecurityContextHolder.setContext(contextBeforeChainExecution);</span><br><span class="line">			<span class="keyword">if</span> (contextBeforeChainExecution.getAuthentication() == <span class="keyword">null</span>) {</span><br><span class="line">				logger.debug(<span class="string">"Set SecurityContextHolder to empty SecurityContext"</span>);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) {</span><br><span class="line">					<span class="keyword">this</span>.logger</span><br><span class="line">							.debug(LogMessage.format(<span class="string">"Set SecurityContextHolder to %s"</span>, contextBeforeChainExecution));</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			chain.doFilter(holder.getRequest(), holder.getResponse());</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">finally</span> {</span><br><span class="line">			SecurityContext contextAfterChainExecution = SecurityContextHolder.getContext();</span><br><span class="line">			<span class="comment">// Crucial removal of SecurityContextHolder contents before anything else.</span></span><br><span class="line">			SecurityContextHolder.clearContext();</span><br><span class="line">			<span class="keyword">this</span>.repo.saveContext(contextAfterChainExecution, holder.getRequest(), holder.getResponse());</span><br><span class="line">			request.removeAttribute(FILTER_APPLIED);</span><br><span class="line">			<span class="keyword">this</span>.logger.debug(<span class="string">"Cleared SecurityContextHolder to complete request"</span>);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Huang Qingshan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://alifebug.github.io/2020/12/02/SpringSecurity/">http://alifebug.github.io/2020/12/02/SpringSecurity/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://ALifeBug.github.io">ALifeBug</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.png"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.png"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2020/11/25/Hutool%E5%B7%A5%E5%85%B7%E5%8C%85/"><img class="next_cover lozad" data-src="https://s2.ax1x.com/2019/11/04/Kv8O6U.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Hutool工具包</span></div></a></div></nav></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2020 By Huang Qingshan</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>